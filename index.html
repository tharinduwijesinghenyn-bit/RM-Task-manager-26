<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>RM Task Manager ‚Äî Smart Time Calculator with Progress Charts</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
    <style>
        :root{ 
            --bg1:#0c0d12; 
            --bg2:#07124a; 
            --gold:#FFD700; 
            --muted:#cfcfcf; 
            --warn:#FF4444; 
            --good:#00c853; 
            --bad:#ff3d00; 
            --high:#ff6666; 
            --med:#ffb74d; 
            --low:#90caf9; 
            --leave:#ffc107;
            --sidebar-width: 280px;
            --sidebar-collapsed: 60px;
            --card-bg: rgba(255, 255, 255, 0.05);
            --card-border: rgba(255, 255, 255, 0.08);
            --hover-bg: rgba(255, 255, 255, 0.08);
        }
        
        body{ 
            margin:0; 
            font-family: 'Inter', Arial, Helvetica, sans-serif; 
            background: linear-gradient(135deg, var(--bg1), var(--bg2)); 
            color:#fff; 
            display: flex;
            min-height: 100vh;
            line-height: 1.5;
            
        }
        
        /* Welcome Screen Styles */
        #welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--bg1), var(--bg2));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.8s ease, transform 0.8s ease;
        }
        
        .welcome-content {
            text-align: center;
            max-width: 600px;
            padding: 40px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .welcome-title {
            font-size: 3.5rem;
            font-weight: 800;
            color: var(--gold);
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            animation: titleGlow 2s infinite alternate;
        }
        
        .welcome-subtitle {
            font-size: 1.5rem;
            color: var(--gold);
            margin-bottom: 40px;
            font-weight: 500;
        }
        
        .welcome-animation {
            width: 120px;
            height: 120px;
            margin: 0 auto 40px;
            position: relative;
        }
        
        .welcome-animation .circle {
            position: absolute;
            border-radius: 50%;
            border: 3px solid var(--gold);
            animation: pulse 2s infinite;
        }
        
        .welcome-animation .circle:nth-child(1) {
            width: 120px;
            height: 120px;
            animation-delay: 0s;
        }
        
        .welcome-animation .circle:nth-child(2) {
            width: 90px;
            height: 90px;
            top: 15px;
            left: 15px;
            animation-delay: 0.3s;
        }
        
        .welcome-animation .circle:nth-child(3) {
            width: 60px;
            height: 60px;
            top: 30px;
            left: 30px;
            animation-delay: 0.6s;
        }
        
        .welcome-animation .circle:nth-child(4) {
            width: 30px;
            height: 30px;
            top: 45px;
            left: 45px;
            animation-delay: 0.9s;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .login-form select, .login-form input {
            padding: 14px 16px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0,0,0,1);
            color: #FFFFFF;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
        }
        
        .login-form select:focus, .login-form input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 6px rgba(255, 215, 0, 0.2);
        }
        
        .login-btn {
            padding: 14px 16px;
            border-radius: 10px;
            border: none;
            background: var(--gold);
            color: #111;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        .login-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 215, 0, 0.4);
        }
        
        .welcome-footer {
            margin-top: 40px;
            color: var(--muted);
            font-size: 0.9rem;
        }
        
        /* Animations */
        @keyframes titleGlow {
            0% {
                text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            }
            100% {
                text-shadow: 0 0 30px rgba(255, 215, 0, 0.8), 0 0 40px rgba(255, 215, 0, 0.4);
            }
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(1.2);
                opacity: 0;
            }
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            overflow-y: auto;
            height: 100vh;
            position: sticky;
            top: 0;
            z-index: 10;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--card-border);
        }
        
        .sidebar.collapsed {
            width: var(--sidebar-collapsed);
        }
        
        .sidebar-header {
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--card-border);
        }
        
        .sidebar-title {
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--gold);
            white-space: nowrap;
            
        }
        
        .toggle-sidebar {
            background: transparent;
            border: none;
            color: var(--muted);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .toggle-sidebar:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-content {
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .control-group h3 {
            margin: 0;
            font-size: 0.9rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        
        /* Main Content Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
        
        header{ 
            padding: 16px 24px; 
            background: rgba(0, 0, 0, 0.3); 
            backdrop-filter: blur(10px);
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            position: sticky; 
            top: 0; 
            z-index: 5; 
            gap: 16px; 
            border-bottom: 1px solid var(--card-border);
        }
        
        .title { 
            font-size: 1.4rem; 
            font-weight: 800; 
            letter-spacing: 0.4px; 
            display: flex; 
            gap: 12px; 
            align-items: center; 
        }
        
        #clock { 
            color: var(--gold); 
            font-size: 1rem; 
            font-weight: 500;
        }
        
        .controls { 
            display: flex; 
            gap: 12px; 
            flex-wrap: wrap; 
            padding: 16px; 
            justify-content: center; 
            align-items: center; 
            background: rgba(255, 255, 255, 0.02); 
            border-bottom: 1px solid var(--card-border);
        }
        
        select, input, button, textarea { 
            padding: 10px 12px; 
            border-radius: 8px; 
            border: none; 
            min-width: 160px; 
            font-size: 0.95rem; 
            font-family: 'Inter', sans-serif;
            transition: all 0.2s ease;
        }
        
        select, input {
            background: rgba(0,0,0,1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.2);
        }
        
        button { 
            background: var(--gold); 
            color: #111; 
            font-weight: 600; 
            cursor: pointer; 
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
        }
        
        #export-pdf-btn { 
            background: #2b9cff; 
            color: #fff; 
        }
        
        #daily-chart-btn { 
            background: #28a745; 
            color: #fff; 
        }
        
        .shift-container { 
            padding: 24px; 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); 
            gap: 24px; 
        }
        
        .shift { 
            background: var(--card-bg); 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4); 
            position: relative;
            border: 1px solid var(--card-border);
            transition: all 0.3s ease;
        }
        
        .shift:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.5);
        }
        
        .shift h2 { 
            color: var(--gold); 
            margin: 0 0 12px 0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            gap: 12px; 
            font-size: 1.3rem;
        }
        
        ul{ 
            list-style: none; 
            padding: 0; 
            margin: 0; 
        }
        
        li{ 
            background: rgba(255, 255, 255, 0.03); 
            margin: 10px 0; 
            padding: 14px; 
            border-radius: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            gap: 16px; 
            border-left: 4px solid transparent; 
            position: relative;
            transition: all 0.2s ease;
        }
        
        li:hover {
            background: var(--hover-bg);
            transform: translateX(4px);
        }
        
        .left { 
            display: flex; 
            gap: 12px; 
            align-items: center; 
            min-width: 0; 
            flex: 1; 
        }
        
        .name { 
            font-weight: 700; 
            min-width: 0; 
            white-space: nowrap; 
             
            text-overflow: ellipsis; 
            font-size: 1rem;
        }
        
        .task { 
            font-style: italic; 
            opacity: 0.95; 
            color: var(--muted); 
            max-width: 240px; 
            white-space: nowrap; 
             
            text-overflow: ellipsis; 
            font-size: 0.9rem;
        }
        
        .time { 
            color: var(--gold); 
            font-weight: 700; 
            min-width: 110px; 
            text-align: right; 
            font-family: monospace; 
            font-size: 1rem;
        }
        
        .start-end { 
            display: flex; 
            gap: 8px; 
            margin-left: 10px; 
            flex-wrap: wrap; 
        }
        
        .small { 
            padding: 8px 12px; 
            min-width: 90px; 
            border-radius: 8px; 
            font-weight: 600; 
            cursor: pointer; 
            background: #2b3e66; 
            color: #fff; 
            border: none; 
            font-size: 0.85rem;
        }
        
        .small:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .support-badge { 
            background: rgba(255, 255, 255, 0.05); 
            padding: 6px 10px; 
            border-radius: 8px; 
            font-size: 0.85rem; 
            color: var(--muted); 
            margin-left: 8px; 
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .muted { 
            color: var(--muted); 
        }

        /* attendance status */
        .att { 
            font-weight: 700; 
            padding: 6px 10px; 
            border-radius: 999px; 
            font-size: 0.85rem; 
        }
        
        .att.present{ 
            background: rgba(0, 200, 83, 0.15); 
            color: var(--good); 
            border: 1px solid rgba(0, 200, 83, 0.3); 
        }
        
        .att.absent{ 
            background: rgba(255, 61, 0, 0.15); 
            color: var(--bad); 
            border: 1px solid rgba(255, 61, 0, 0.3); 
        }
        
        .att.unmarked{ 
            background: rgba(255, 213, 74, 0.15); 
            color: #ffd54a; 
            border: 1px solid rgba(255, 213, 74, 0.3); 
            animation: blink 1.4s infinite; 
        }
        
        @keyframes blink { 
            0%, 50%, 100% { opacity: 1 } 
            25%, 75% { opacity: 0.5 } 
        }

        /* warning dot + blink */
        .warning-dot { 
            width: 12px; 
            height: 12px; 
            border-radius: 50%; 
            background: var(--warn); 
            margin-right: 8px; 
            box-shadow: 0 0 8px rgba(255, 68, 68, 0.8); 
        }
        
        .blink { 
            animation: blink 1s infinite; 
        }

        /* Global Warning Indicator */
        .global-warning {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--warn);
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: blink 1s infinite;
        }
        
        .global-warning::after {
            content: "‚ö†Ô∏è";
            font-size: 24px;
        }

        /* Display overlay */
        #display-overlay { 
            display: none; 
            position: fixed; 
            inset: 0; 
            z-index: 9999; 
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.95), rgba(0, 0, 0, 0.98)); 
            color: #fff; 
            overflow: auto; 
            padding: 24px; 
        }
        
        #display-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            gap: 16px; 
            margin-bottom: 16px; 
        }
        
        #display-title { 
            font-size: 1.8rem; 
            color: var(--gold); 
            font-weight: 800; 
        }
        
        #display-content { 
            display: grid; 
            gap: 20px; 
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); 
        }

        /* Chart modal */
        #chart-modal { 
            display: none; 
            position: fixed; 
            inset: 0; 
            z-index: 10000; 
            background: rgba(0, 0, 0, 0.9); 
            align-items: center; 
            justify-content: center; 
            padding: 24px; 
        }
        
        .chart-card { 
            background: var(--card-bg); 
            border-radius: 16px; 
            padding: 24px; 
            width: 900px; 
            max-width: calc(100% - 48px); 
            border: 1px solid var(--card-border);
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.5);
        }
        
        .chart-card h3 { 
            margin: 0 0 12px 0; 
            color: var(--gold); 
            font-size: 1.4rem;
        }
        
        .chart-actions { 
            display: flex; 
            justify-content: flex-end; 
            gap: 12px; 
            margin-bottom: 12px; 
        }
        
        .notice { 
            background: rgba(255, 255, 255, 0.05); 
            padding: 16px; 
            border-radius: 10px; 
            text-align: center; 
            margin-bottom: 16px; 
            border: 1px solid var(--card-border);
        }

        /* Priority badges */
        .prio { 
            padding: 6px 10px; 
            border-radius: 8px; 
            font-weight: 700; 
            font-size: 0.85rem; 
            color: #111; 
            display: inline-block; 
        }
        
        .prio.high{ 
            background: var(--high); 
        }
        
        .prio.med{ 
            background: var(--med); 
            color: #111;
        }
        
        .prio.low{ 
            background: var(--low); 
            color: #111;
        }

        /* Leave badges */
        .leave-badge {
            background: rgba(255, 193, 7, 0.2);
            color: var(--leave);
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 0.85rem;
            margin-left: 8px;
            border: 1px solid rgba(255, 193, 7, 0.3);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* toast */
        #toast { 
            position: fixed; 
            right: 24px; 
            bottom: 24px; 
            z-index: 12000; 
            background: rgba(0, 0, 0, 0.8); 
            color: #fff; 
            padding: 16px 20px; 
            border-radius: 10px; 
            display: none; 
            min-width: 240px; 
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            border: 1px solid var(--card-border);
        }

        /* login modal */
        #login-modal, #qr-modal, #change-pass-modal, #leave-modal { 
            display: none; 
            position: fixed; 
            inset: 0; 
            z-index: 11000; 
            background: rgba(0, 0, 0, 0.9); 
            align-items: center; 
            justify-content: center; 
            padding: 24px; 
        }
        
        .modal-card { 
            background: var(--card-bg); 
            border-radius: 16px; 
            padding: 24px; 
            width: 460px; 
            max-width: calc(100% - 48px); 
            color: #fff; 
            border: 1px solid var(--card-border);
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.5);
        }
        
        .row { 
            display: flex; 
            gap: 12px; 
            align-items: center; 
        }

        /* Simple Time Calculator Modal */
        #time-calc-modal {
            display: none; 
            position: fixed; 
            inset: 0; 
            z-index: 11000; 
            background: rgba(0, 0, 0, 0.9); 
            align-items: center; 
            justify-content: center; 
            padding: 24px; 
        }
        
        .calc-card {
            background: var(--card-bg); 
            border-radius: 16px; 
            padding: 24px; 
            width: 440px; 
            max-width: calc(100% - 48px); 
            color: #fff; 
            border: 1px solid var(--card-border);
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.5);
        }
        
        .calc-section {
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid var(--card-border);
        }
        
        .calc-section h4 {
            margin: 0 0 12px 0;
            color: var(--gold);
            font-size: 1.1rem;
        }
        
        .calc-input-group {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .calc-input-group label {
            min-width: 140px;
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        .calc-input-group input, .calc-input-group select {
            flex: 1;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            width: 100px;
        }
        
        .time-indicator {
            margin-top: 16px;
            padding: 14px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-size: 0.95rem;
            text-align: center;
            border: 1px solid var(--card-border);
        }
        
        .time-indicator.normal {
            color: var(--good);
        }
        
        .time-indicator.warning {
            color: var(--warn);
            animation: blink 1s infinite;
            font-weight: bold;
        }
        
        .time-indicator.critical {
            color: var(--warn);
            background: rgba(255, 68, 68, 0.1);
            animation: blink 0.5s infinite;
            font-weight: bold;
        }

        /* Leave Modal Styles */
        .leave-section {
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid var(--card-border);
        }
        
        .leave-section h4 {
            margin: 0 0 12px 0;
            color: var(--gold);
            font-size: 1.1rem;
        }
        
        .leave-input-group {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .leave-input-group label {
            min-width: 120px;
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        .leave-input-group input, .leave-input-group select {
            flex: 1;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .leave-summary {
            margin-top: 16px;
            padding: 14px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-size: 0.95rem;
            text-align: center;
            border: 1px solid var(--card-border);
            color: var(--leave);
        }

        /* Sidebar collapsed styles */
        .sidebar.collapsed .sidebar-title,
        .sidebar.collapsed .control-group h3,
        .sidebar.collapsed .control-group label {
            display: none;
        }
        
        .sidebar.collapsed .control-group {
            align-items: center;
        }
        
        .sidebar.collapsed select,
        .sidebar.collapsed input,
        .sidebar.collapsed button {
            min-width: auto;
            width: 44px;
            height: 44px;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            
        }
        
        .sidebar.collapsed .control-group button span {
            display: none;
        }
        
        .sidebar.collapsed .control-group button::before {
            content: attr(data-icon);
            font-size: 1.3rem;
        }

        /* Time Management Styles */
        .time-management {
            margin-top: 8px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            font-size: 0.85rem;
        }
        
        .time-balance {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        
        .time-progress {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            
            margin-bottom: 4px;
        }
        
        .time-progress-bar {
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .time-progress-bar.normal {
            background: var(--good);
        }
        
        .time-progress-bar.warning {
            background: var(--med);
        }
        
        .time-progress-bar.critical {
            background: var(--warn);
            animation: blink 1s infinite;
        }
        
        .time-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--muted);
        }

        /* Progress Charts */
        .progress-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
            padding: 0 24px;
        }
        
        .chart-container {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--card-border);
            transition: all 0.3s ease;
        }
        
        .chart-container:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.5);
        }
        
        .chart-container h3 {
            margin: 0 0 12px 0;
            color: var(--gold);
            font-size: 1.1rem;
            text-align: center;
        }
        
        .chart-wrapper {
            position: relative;
            height: 200px;
        }

        /* Multiple Tasks Styles */
        .task-list {
            margin-top: 8px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            font-size: 0.85rem;
        }
        
        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            margin-bottom: 4px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            border-left: 3px solid transparent;
        }
        
        .task-item.completed {
            border-left-color: var(--good);
            opacity: 0.8;
        }
        
        .task-item.running {
            border-left-color: var(--gold);
        }
        
        .task-item.overdue {
            border-left-color: var(--warn);
        }
        
        .task-info {
            flex: 1;
            min-width: 0;
        }
        
        .task-name {
            font-weight: 600;
            white-space: nowrap;
            
            text-overflow: ellipsis;
        }
        
        .task-time {
            font-size: 0.75rem;
            color: var(--muted);
            display: flex;
            gap: 8px;
        }
        
        .task-status {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .status-completed {
            background: rgba(0, 200, 83, 0.2);
            color: var(--good);
        }
        
        .status-running {
            background: rgba(255, 215, 0, 0.2);
            color: var(--gold);
        }
        
        .status-pending {
            background: rgba(158, 158, 158, 0.2);
            color: var(--muted);
        }
        
        .status-overdue {
            background: rgba(255, 68, 68, 0.2);
            color: var(--warn);
        }
        
        .add-task-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px dashed rgba(255, 255, 255, 0.3);
            color: var(--muted);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            width: 100%;
            text-align: center;
            margin-top: 6px;
            transition: all 0.2s ease;
        }
        
        .add-task-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--gold);
            color: var(--gold);
        }
        
        .task-controls {
            display: flex;
            gap: 4px;
            margin-left: 8px;
        }
        
        .task-control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--muted);
            border-radius: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.2s ease;
        }
        
        .task-control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .task-control-btn.start {
            color: var(--good);
        }
        
        .task-control-btn.stop {
            color: var(--warn);
        }
        
        .task-control-btn.complete {
            color: var(--good);
        }
        
        .task-control-btn.delete {
            color: var(--bad);
        }

        @media (max-width: 1024px) {
            .sidebar {
                position: fixed;
                left: 0;
                transform: translateX(-100%);
                z-index: 20;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                width: 100%;
            }
            
            .mobile-menu-toggle {
                display: block;
                position: fixed;
                top: 16px;
                left: 16px;
                z-index: 15;
                background: var(--gold);
                color: #111;
                border: none;
                border-radius: 8px;
                padding: 10px 14px;
                font-weight: 700;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            }
        }
        
        @media (max-width: 768px){ 
            .controls{flex-direction:column;align-items:center;} 
            select,input{min-width:100%} 
            .chart-card{width:100%} 
            .modal-card{width:100%} 
            .calc-card{width:100%}
            .calc-input-group {
                flex-direction: column;
                align-items: flex-start;
            }
            .calc-input-group label {
                min-width: auto;
            }
            .leave-input-group {
                flex-direction: column;
                align-items: flex-start;
            }
            .leave-input-group label {
                min-width: auto;
            }
            
            .welcome-title {
                font-size: 2.5rem;
            }
            
            .welcome-subtitle {
                font-size: 1.2rem;
            }
            
            .progress-charts {
                grid-template-columns: 1fr;
                padding: 0 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Welcome Screen -->
    <div id="welcome-screen">
        <div class="welcome-content">
            <div class="welcome-animation">
                <div class="circle"></div>
                <div class="circle"></div>
                <div class="circle"></div>
                <div class="circle"></div>
            </div>
            <h1 class="welcome-title">RM TASK MANAGER</h1>
            <p class="welcome-subtitle">Smart Time Calculator with Progress Charts</p>
            
            <form class="login-form" id="welcome-login-form">
                <select id="welcome-user-select" required>
                    <option value="">Select User</option>
                    <option value="Thushara">Thushara</option>
                    <option value="Thusitha">Thusitha</option>
                    <option value="Supun">Supun</option>
                    <option value="Tharindu">Tharindu (Administrator)</option>
                </select>
                <input type="password" id="welcome-password" placeholder="Password" required>
                <button type="submit" class="login-btn">Login</button>
            </form>
            
            <div class="welcome-footer">
                Default password: 1234
            </div>
        </div>
    </div>

    <!-- Global Warning Indicator -->
    <div class="global-warning" id="global-warning"></div>

    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" id="mobile-menu-toggle" style="display: none;">‚ò∞ Menu</button>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">Control Panel</div>
            <button class="toggle-sidebar" id="toggle-sidebar">‚óÄ</button>
        </div>
        
        <div class="sidebar-content">
            <!-- Shift Selection -->
            <div class="control-group">
                <h3>Shift Selection</h3>
                <select id="shift-select"><option value="">Select Shift</option></select>
            </div>
            
            <!-- Member & Task Assignment -->
            <div class="control-group">
                <h3>Task Assignment</h3>
                <select id="member-select"><option value="">Select Member</option></select>
                <select id="task-select">
                    <option value="">Select Task</option>
                    <option>Commission Greige GRN</option>
                    <option>Batch card Issue</option>
                    <option>Yarn Unloading & GRN</option>
                    <option>Yarn Issue-Knitting</option>
                    <option>Yarn Issue-Beaming</option>
                    <option>Beam Unloading & GRN</option>
                    <option>Web Split & Sample Cutting</option>
                    <option>Return Yarn Taking</option>
                    <option>Inhouse greige taking</option>
                    <option>OTHER</option>
                </select>
                <input id="custom-task" placeholder="Enter custom task" style="display:none;" />
                <select id="priority-select" title="Priority">
                    <option value="">Priority</option>
                    <option value="high">High</option>
                    <option value="med">Medium</option>
                    <option value="low">Low</option>
                </select>
                <button id="assign-btn" data-icon="‚úì"><span>Assign</span></button>
            </div>
            
            <!-- Employee Management -->
            <div class="control-group">
                <h3>Employee Management</h3>
                <input id="new-emp-name" placeholder="New Employee Name" />
                <button id="add-emp-btn" data-icon="+"><span>Add Employee</span></button>
            </div>
            
            <!-- Time Management -->
            <div class="control-group">
                <h3>Time Management</h3>
                <button id="reset-daily-times" data-icon="üîÑ" style="background: #10b981;"><span>Reset Daily Times</span></button>
                <button id="daily-time-report" data-icon="üìä" style="background: #3b82f6;"><span>Daily Time Report</span></button>
                <button id="shift-time-report" data-icon="üìã" style="background: #8b5cf6;"><span>Shift Time Report</span></button>
            </div>
            
            <!-- Short Leave Management -->
            <div class="control-group">
                <h3>Short Leave Management</h3>
                <button id="manage-leave-btn" data-icon="‚è±Ô∏è" style="background: var(--leave); color: #111;"><span>Manage Short Leave</span></button>
            </div>
            
            <!-- Support Assignment -->
            <div class="control-group">
                <h3>Support Assignment</h3>
                <select id="support-select" title="Select a support member">
                    <option value="">Select Support Member</option>
                </select>
                <button id="assign-support-btn" data-icon="üîÑ"><span>Assign Support</span></button>
            </div>
            
            <!-- Export & Reports -->
            <div class="control-group">
                <h3>Export & Reports</h3>
                <button id="export-pdf-btn" data-icon="üìÑ"><span>Export PDF</span></button>
                <button id="csv-export-btn" style="background:#6b46c1" data-icon="üìä"><span>Export CSV</span></button>
                <button id="daily-chart-btn" data-icon="üìà"><span>Daily Report & Chart</span></button>
                <button id="progress-chart-btn" style="background:#ec4899" data-icon="üìä"><span>Progress Charts</span></button>
            </div>
            
            <!-- Display & Dashboard -->
            <div class="control-group">
                <h3>Display & Dashboard</h3>
                <button id="display-btn" data-icon="üñ•Ô∏è"><span>Display</span></button>
                <button id="dashboard-btn" style="background:#10b981" data-icon="üìä"><span>Dashboard</span></button>
            </div>
            
            <!-- Search & Filter -->
            <div class="control-group">
                <h3>Search & Filter</h3>
                <input id="search-input" placeholder="Search member or task..." />
                <select id="filter-select">
                    <option value="">Filter</option>
                    <option value="overdue">Only Overdue</option>
                    <option value="running">Only Running</option>
                    <option value="unassigned">Unassigned</option>
                    <option value="onleave">On Leave</option>
                    <option value="lowbalance">Low Balance</option>
                </select>
            </div>
            
            <!-- QR & Attendance -->
            <div class="control-group">
                <h3>QR & Attendance</h3>
                <button id="qr-btn" style="background:#0ea5e9" data-icon="üì±"><span>QR Check-in</span></button>
            </div>
            
            <!-- Status Indicators -->
            <div class="control-group">
                <h3>System Status</h3>
                <div style="color:var(--muted); font-size: 0.85rem;">
                    <div>Auto-save: <span id="autosave-ind">ON</span></div>
                    <div>Cloud Sync: <span id="cloud-status">Local only</span></div>
                    <div>Selected Shift: <span id="shift-time-display">-</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <header>
            <div style="display:flex;align-items:center;gap:12px;">
                <div class="title">RM TASK MANAGER ‚Äî Smart Time Calculator</div>
                <div style="font-size:0.85rem;opacity:0.9">Extended</div>
            </div>

            <div style="display:flex;gap:10px;align-items:center;">
                <div id="user-role" class="muted" style="font-weight:700"></div>
                <div id="clock" class="muted"></div>
                <button id="login-btn" style="background:transparent;border:1px solid rgba(255,255,255,0.1);color:#fff;padding:8px 12px;border-radius:8px;font-weight:600;">Login</button>
                <button id="change-pass-btn" style="background:#6b7280;color:#fff;padding:8px 12px;border-radius:8px;font-weight:600;display:none;margin-left:8px;">Change Password</button>
                <button id="logout-btn" style="background:#ff5252;color:#fff;padding:8px 12px;border-radius:8px;font-weight:600;display:none;margin-left:8px;">Logout</button>
            </div>
        </header>

        <!-- Progress Charts Section -->
        <div class="progress-charts" id="progress-charts">
            <div class="chart-container">
                <h3>Task Completion Progress</h3>
                <div class="chart-wrapper">
                    <canvas id="taskCompletionChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <h3>Time Utilization</h3>
                <div class="chart-wrapper">
                    <canvas id="timeUtilizationChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <h3>Task Distribution</h3>
                <div class="chart-wrapper">
                    <canvas id="taskDistributionChart"></canvas>
                </div>
            </div>
        </div>

        <div class="shift-container" id="shift-container"></div>
    </div>

    <!-- Display overlay -->
    <div id="display-overlay" role="dialog" aria-modal="true">
        <div id="display-header">
            <div id="display-title">Live Display</div>
            <div style="display:flex; gap:8px; align-items:center;">
                <div id="display-clock" class="muted"></div>
                <button id="exit-display" style="background:#fff;color:#111;padding:8px 12px;border-radius:8px;font-weight:700;">Close Display</button>
            </div>
        </div>
        <div class="notice">Live readonly view for everyone ‚Äî shows only members with an assigned task (unless empty).</div>
        <div id="display-content"></div>
    </div>

    <!-- Chart modal -->
    <div id="chart-modal" role="dialog" aria-modal="true">
        <div class="chart-card">
            <div class="chart-actions">
                <button id="close-chart" style="background:#fff;color:#111;padding:8px 10px;border-radius:8px;font-weight:700;">Close</button>
            </div>
            <h3>Daily Summary (07:00 - 19:00)</h3>
            <canvas id="dailyChart" width="800" height="320"></canvas>
            <div style="margin-top:12px; color:var(--muted);">Chart shows total duration (seconds) per Task for the selected day/time window.</div>
        </div>
    </div>

    <!-- Simple Time Calculator Modal -->
    <div id="time-calc-modal">
        <div class="calc-card">
            <h3 style="color:var(--gold)">Task Time Calculator</h3>
            
            <div class="calc-section">
                <h4 id="calc-task-title">Commission Greige GRN Calculation</h4>
                
                <!-- Task-specific inputs -->
                <div id="task-inputs" class="calc-input-group">
                    <label id="quantity-label">Number of Webs:</label>
                    <input type="number" id="quantity-input" value="12" min="1" step="1">
                </div>
                
                <div class="time-indicator normal" id="time-indicator">
                    Estimated Time: 21 minutes
                </div>
                
                <!-- Task Reference Table -->
                <div id="task-reference" style="margin-top: 12px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                    <h4 style="margin: 0 0 8px 0; color: var(--gold);">Task Reference</h4>
                    <div style="font-size: 0.8rem; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px;">
                        <div><strong>Normal Qty</strong></div>
                        <div><strong>Time</strong></div>
                        <div><strong>Additional Qty Time</strong></div>
                        <div>12 webs</div><div>21 min</div><div>1.2 min/web</div>
                    </div>
                </div>
            </div>
            
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
                <button id="calc-cancel" style="background:#6b7280">Cancel</button>
                <button id="calc-apply" style="background:var(--gold);color:#111">Assign Task</button>
            </div>
        </div>
    </div>

    <!-- Leave Management Modal -->
    <div id="leave-modal">
        <div class="modal-card">
            <h3 style="color:var(--gold)">Short Leave Management</h3>
            
            <div class="leave-section">
                <h4>Apply Short Leave</h4>
                <div class="leave-input-group">
                    <label>Select Member:</label>
                    <select id="leave-member-select">
                        <option value="">Select Member</option>
                    </select>
                </div>
                <div class="leave-input-group">
                    <label>Leave Type:</label>
                    <select id="leave-type">
                        <option value="short_leave">Short Leave</option>
                        <option value="half_day">Half Day</option>
                        <option value="full_day">Full Day</option>
                    </select>
                </div>
                <div class="leave-input-group">
                    <label>Start Time:</label>
                    <input type="time" id="leave-start-time">
                </div>
                <div class="leave-input-group">
                    <label>End Time:</label>
                    <input type="time" id="leave-end-time">
                </div>
                <div class="leave-input-group">
                    <label>Reason (Optional):</label>
                    <input type="text" id="leave-reason" placeholder="Enter reason for leave">
                </div>
                
                <div class="leave-summary" id="leave-summary">
                    Select a member and set leave times
                </div>
            </div>
            
            <div style="display:flex;gap:8px;justify-content:space-between;margin-top:12px">
                <button id="clear-leave-btn" style="background:#6b7280">Clear Leave</button>
                <div style="display:flex;gap:8px;">
                    <button id="leave-cancel" style="background:#6b7280">Cancel</button>
                    <button id="leave-apply" style="background:var(--leave);color:#111">Apply Leave</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast"></div>

    <!-- Login modal -->
    <div id="login-modal">
        <div class="modal-card">
            <h3 style="color:var(--gold)">Sign in</h3>
            <div style="margin-top:8px" class="row">
                <select id="login-name" style="flex:1">
                    <!-- options populated dynamically -->
                </select>
            </div>
            <div style="margin-top:8px" class="row">
                <input id="login-password" placeholder="Password" type="password" style="flex:1" />
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
                <button id="login-close" style="background:#6b7280">Cancel</button>
                <button id="login-submit" style="background:var(--gold);color:#111">Sign in</button>
            </div>
            <div style="margin-top:10px;color:var(--muted);font-size:0.85rem">
                Default accounts: <strong>Thushara, Thusitha, Supun, Tharindu</strong> ‚Äî default password <strong>1234</strong>. You can change your password after login.
            </div>
        </div>
    </div>

    <!-- Change password modal -->
    <div id="change-pass-modal">
        <div class="modal-card">
            <h3 style="color:var(--gold)">Change Password</h3>
            <div style="margin-top:8px" class="row">
                <input id="cp-current" placeholder="Current password" type="password" style="flex:1" />
            </div>
            <div style="margin-top:8px" class="row">
                <input id="cp-new" placeholder="New password" type="password" style="flex:1" />
            </div>
            <div style="margin-top:8px" class="row">
                <input id="cp-confirm" placeholder="Confirm new password" type="password" style="flex:1" />
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
                <button id="cp-close" style="background:#6b7280">Cancel</button>
                <button id="cp-submit" style="background:var(--gold);color:#111">Change</button>
            </div>
            <div id="cp-msg" style="margin-top:8px;color:#ffb74d;font-size:0.9rem"></div>
        </div>
    </div>

    <!-- QR modal -->
    <div id="qr-modal">
        <div class="modal-card" id="qr-card">
            <h3 style="color:var(--gold)">QR Check-in / Generate</h3>
            <div style="margin-top:8px; display:flex; gap:8px;">
                <select id="qr-member-select" style="flex:1"></select>
                <button id="generate-qr">Generate QR</button>
                <button id="scan-qr" style="background:#10b981">Scan to Check-in</button>
            </div>
            <div id="qr-output" style="margin-top:12px"></div>
            <div id="qr-scanner" style="margin-top:12px"></div>

            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
                <button id="qr-close" style="background:#6b7280">Close</button>
            </div>
        </div>
    </div>

    <!-- Dashboard modal -->
    <div id="dashboard-modal" style="display:none;position:fixed;inset:0;z-index:12000;background:rgba(0,0,0,0.9);align-items:center;justify-content:center;padding:20px;">
        <div class="chart-card">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <h3 style="color:var(--gold)">Performance Dashboard</h3>
                <div>
                    <button id="dash-close" style="background:#fff;color:#111;padding:6px 10px;border-radius:8px;">Close</button>
                </div>
            </div>
            <div style="margin-top:12px;">
                <canvas id="perfChart" width="900" height="320"></canvas>
            </div>
            <div style="margin-top:12px; color:var(--muted)" id="perf-summary"></div>
        </div>
    </div>

    <script>
        // ==================== TASK TIME CALCULATIONS ====================
        
        /* ------------------ Task Time Constants ------------------ */
        const TASK_TIME_CONSTANTS = {
            "Commission Greige GRN": {
                normalQty: 12,
                normalTime: 21,
                unit: "webs",
                additionalTime: 1.2
            },
            "Batch card Issue": {
                normalQty: 32,
                normalTime: 124,
                unit: "webs",
                additionalTime: 3.9
            },
            "Yarn Unloading & GRN": {
                normalQty: 12,
                normalTime: 36,
                unit: "boxes",
                additionalTime: 1.6
            },
            "Yarn Issue-Knitting": {
                normalQty: 4,
                normalTime: 43.5,
                unit: "boxes",
                additionalTime: 3.6
            },
            "Yarn Issue-Beaming": {
                normalQty: 4,
                normalTime: 27.5,
                unit: "boxes",
                additionalTime: 2.3
            },
            "Beam Unloading & GRN": {
                normalQty: 3,
                normalTime: 76,
                unit: "beams",
                additionalTime: 48.5
            },
            "Web Split & Sample Cutting": {
                normalQty: 1,
                normalTime: 18,
                unit: "webs",
                additionalTime: 18
            },
            "Return Yarn Taking": {
                normalQty: 2,
                normalTime: 24.5,
                unit: "boxes",
                additionalTime: 7
            },
            "Inhouse greige taking": {
                normalQty: 32,
                normalTime: 77.5,
                unit: "webs",
                additionalTime: 1.5
            }
        };

        // Calculate task time based on quantity
        function calculateTaskTime(taskName, quantity) {
            const task = TASK_TIME_CONSTANTS[taskName];
            if (!task) return { totalTime: 0, details: "Task not found" };
            
            const qty = parseFloat(quantity) || 1;
            let totalTime = 0;
            let details = "";
            
            if (qty <= task.normalQty) {
                // For quantities up to normal, use proportional time
                totalTime = (qty / task.normalQty) * task.normalTime;
                details = `${qty} ${task.unit} (proportional calculation)`;
            } else {
                // For quantities beyond normal: normal time + (extra units * additional time)
                const extraUnits = qty - task.normalQty;
                totalTime = task.normalTime + (extraUnits * task.additionalTime);
                details = `${task.normalQty} ${task.unit} base + ${extraUnits} extra ${task.unit}`;
            }
            
            return {
                totalTime: totalTime,
                details: details,
                unit: task.unit,
                normalQty: task.normalQty,
                extraUnits: Math.max(0, qty - task.normalQty)
            };
        }

        // ==================== MULTIPLE TASKS IMPLEMENTATION ====================

        /* ------------------ Task Structure for Multiple Tasks ------------------ */
        const DEFAULT_TASK = {
            id: null,
            name: '',
            priority: '',
            status: 'pending', // 'pending', 'running', 'completed'
            startTime: null,
            elapsedSeconds: 0,
            calculatedDuration: 0,
            taskDetails: null,
            support: null,
            completedBy: null,
            createdAt: null,
            completedAt: null
        };

        /* ------------------ Initialize Member Tasks ------------------ */
        function initializeMemberTasks() {
            shifts.forEach(shift => {
                shift.members.forEach(member => {
                    // Ensure tasks array exists
                    if (!member.tasks) {
                        member.tasks = [];
                    }
                    
                    // Migrate single task to tasks array if needed
                    if (member.task && member.task.trim() !== '') {
                        const existingTask = member.tasks.find(t => t.name === member.task);
                        if (!existingTask) {
                            member.tasks.push({
                                ...DEFAULT_TASK,
                                id: generateTaskId(),
                                name: member.task,
                                priority: member.priority || '',
                                status: member.isRunning ? 'running' : 'pending',
                                startTime: member.startTime,
                                elapsedSeconds: member.elapsed || 0,
                                calculatedDuration: member.calculatedDuration || 0,
                                taskDetails: member.taskDetails || null,
                                support: member.support || null,
                                createdAt: member._startedAt || new Date().toISOString()
                            });
                        }
                        
                        // Clear legacy single task fields
                        member.task = '';
                        member.priority = '';
                        member.isRunning = false;
                        member.startTime = null;
                        member.elapsed = 0;
                        member.calculatedDuration = 0;
                        member.taskDetails = null;
                        member.support = null;
                        member._startedAt = null;
                    }
                    
                    // Ensure each task has required fields
                    member.tasks.forEach(task => {
                        if (!task.id) task.id = generateTaskId();
                        if (!task.createdAt) task.createdAt = new Date().toISOString();
                    });
                });
            });
            saveState();
        }

        function generateTaskId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        /* ------------------ Modified Assign Task for Multiple Tasks ------------------ */
        function assignTask(){
            if(!canPerform('assign')) { showToast('Permission denied'); return; }
            const shiftVal = shiftSelect.value; 
            const memberVal = memberSelect.value; 
            let taskVal = taskSelect.value; 
            const pr = prioritySelect.value;
            
            if(!shiftVal || !memberVal || !taskVal){ alert('Please select shift, member and task'); return; }
            
            // Check if this task requires time calculation
            if (Object.keys(TASK_TIME_CONSTANTS).includes(taskVal)) {
                window.pendingAssignment = {
                    shift: shiftVal,
                    member: memberVal,
                    task: taskVal,
                    priority: pr
                };
                openTimeCalculator(taskVal);
                return;
            }
            
            if(taskVal === 'OTHER'){ 
                const c = customTaskInput.value.trim(); 
                if(!c){ alert('Enter custom task'); return; } 
                taskVal = c; 
            }
            
            completeTaskAssignment(shiftVal, memberVal, taskVal, pr);
        }

        /* ------------------ Modified Complete Task Assignment ------------------ */
        function completeTaskAssignment(shiftVal, memberVal, taskVal, pr) {
            if (!shiftVal && window.pendingAssignment) {
                shiftVal = window.pendingAssignment.shift;
                memberVal = window.pendingAssignment.member;
                taskVal = window.pendingAssignment.task;
                pr = window.pendingAssignment.priority;
            }
            
            const s = shifts.find(x => x.shift === shiftVal); 
            const m = s.members.find(x => x.name === memberVal);
            
            if(m){ 
                const finalTask = window.calculatedTaskDescription || taskVal;
                
                // Create new task object
                const newTask = {
                    ...DEFAULT_TASK,
                    id: generateTaskId(),
                    name: finalTask,
                    priority: pr || '',
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };
                
                // Store calculated time and details if available
                if (window.calculatedTaskTime) {
                    newTask.calculatedDuration = window.calculatedTaskTime;
                    newTask.taskDetails = window.calculatedTaskDetails;
                }
                
                // Add task to member's tasks array
                if (!m.tasks) m.tasks = [];
                m.tasks.push(newTask);
                
                renderShifts(); 
                renderDisplay(); 
                saveState(); 
                showToast('Task assigned successfully');
                
                // Clear temporary storage
                delete window.pendingAssignment;
                delete window.calculatedTaskTime;
                delete window.calculatedTaskDescription;
                delete window.calculatedTaskDetails;
            }
        }

        /* ------------------ Task Management Functions ------------------ */
        function startTask(taskId, memberName, shiftName) {
            if(!canPerform('startStop')) { showToast('Permission denied'); return; }
            const s = shifts.find(x => x.shift === shiftName); 
            const m = s.members.find(x => x.name === memberName);
            
            if(m && m.tasks) {
                const task = m.tasks.find(t => t.id === taskId);
                if(task && task.status !== 'completed') {
                    // Stop any other running tasks for this member
                    m.tasks.forEach(t => {
                        if(t.status === 'running' && t.id !== taskId) {
                            t.status = 'pending';
                            t.elapsedSeconds = Math.floor((Date.now() - t.startTime) / 1000);
                            t.startTime = null;
                        }
                    });
                    
                    task.status = 'running';
                    task.startTime = Date.now() - (task.elapsedSeconds * 1000);
                    renderShifts(); 
                    renderDisplay(); 
                    saveState();
                    showToast(`Started task: ${task.name}`);
                }
            }
        }

        function endTask(taskId, memberName, shiftName) {
            if(!canPerform('startStop')) { showToast('Permission denied'); return; }
            const s = shifts.find(x => x.shift === shiftName);
            const m = s.members.find(x => x.name === memberName);
            
            if(m && m.tasks) {
                const task = m.tasks.find(t => t.id === taskId);
                if(task && task.status === 'running') {
                    task.status = 'pending';
                    task.elapsedSeconds = Math.floor((Date.now() - task.startTime) / 1000);
                    task.startTime = null;
                    
                    // Update time tracking
                    updateMemberTime(m.name, s.shift, task.elapsedSeconds);
                    
                    renderShifts(); 
                    renderDisplay(); 
                    saveState();
                    showToast(`Stopped task: ${task.name} ‚Äî ${formatHMS(task.elapsedSeconds)}`);
                }
            }
        }

        function completeTask(taskId, memberName, shiftName) {
            if(!canPerform('startStop')) { showToast('Permission denied'); return; }
            const s = shifts.find(x => x.shift === shiftName);
            const m = s.members.find(x => x.name === memberName);
            
            if(m && m.tasks) {
                const task = m.tasks.find(t => t.id === taskId);
                if(task && task.status !== 'completed') {
                    // If task was running, calculate final elapsed time
                    if(task.status === 'running') {
                        task.elapsedSeconds = Math.floor((Date.now() - task.startTime) / 1000);
                        task.startTime = null;
                    }
                    
                    task.status = 'completed';
                    task.endTime = new Date().toISOString();
                    task.completedAt = new Date().toISOString();
                    
                    // Update time tracking
                    updateMemberTime(m.name, s.shift, task.elapsedSeconds);
                    
                    // Save to history
                    tasksHistory.push({
                        shift: shiftName,
                        member: memberName,
                        task: task.name,
                        start: task.createdAt,
                        end: task.completedAt,
                        durationSecs: task.elapsedSeconds,
                        support: task.support || null,
                        completedBy: task.completedBy || currentUser.name || 'System',
                        attendance: m.attendance || 'unmarked',
                        priority: task.priority || ''
                    });
                    
                    renderShifts(); 
                    renderDisplay(); 
                    saveState();
                    showToast(`Completed task: ${task.name}`);
                }
            }
        }

        function deleteTask(taskId, memberName, shiftName) {
            if(!canPerform('assign')) { showToast('Permission denied'); return; }
            const s = shifts.find(x => x.shift === shiftName);
            const m = s.members.find(x => x.name === memberName);
            
            if(m && m.tasks) {
                const taskIndex = m.tasks.findIndex(t => t.id === taskId);
                if(taskIndex !== -1) {
                    const task = m.tasks[taskIndex];
                    if(confirm(`Delete task "${task.name}"?`)) {
                        m.tasks.splice(taskIndex, 1);
                        renderShifts(); 
                        renderDisplay(); 
                        saveState();
                        showToast('Task deleted');
                    }
                }
            }
        }

        /* ------------------ Auto-Complete Tasks at Time Limit ------------------ */
        function checkTaskTimeLimits() {
            shifts.forEach(shift => {
                shift.members.forEach(member => {
                    if(member.tasks) {
                        member.tasks.forEach(task => {
                            // Check if task has reached its time limit and is still running
                            if(task.status === 'running' && task.calculatedDuration > 0) {
                                const currentElapsed = Math.floor((Date.now() - task.startTime) / 1000);
                                if(currentElapsed >= task.calculatedDuration) {
                                    // Auto-complete the task
                                    task.status = 'completed';
                                    task.elapsedSeconds = currentElapsed;
                                    task.endTime = new Date().toISOString();
                                    task.completedAt = new Date().toISOString();
                                    task.startTime = null;
                                    
                                    // Save to history
                                    tasksHistory.push({
                                        shift: shift.shift,
                                        member: member.name,
                                        task: task.name,
                                        start: task.createdAt,
                                        end: task.completedAt,
                                        durationSecs: task.elapsedSeconds,
                                        support: task.support || null,
                                        completedBy: task.completedBy || 'System (Auto-completed)',
                                        attendance: member.attendance || 'unmarked',
                                        priority: task.priority || ''
                                    });
                                    
                                    showToast(`Task auto-completed: ${member.name} - ${task.name}`);
                                }
                            }
                        });
                    }
                });
            });
        }

        /* ------------------ Render Task List for Member ------------------ */
        function renderTaskList(member, shiftName) {
            if(!member.tasks || member.tasks.length === 0) {
                return `
                    <div class="task-list">
                        <div style="text-align: center; color: var(--muted); font-size: 0.8rem;">
                            No tasks assigned
                        </div>
                        <div class="add-task-btn" onclick="openQuickTaskDialog('${shiftName}', '${member.name}')">
                            + Add Task
                        </div>
                    </div>
                `;
            }
            
            let html = `
                <div class="task-list">
            `;
            
            member.tasks.forEach(task => {
                const isOverdue = isTaskOverdue(task);
                const statusClass = task.status === 'completed' ? 'completed' : 
                                  task.status === 'running' ? 'running' : '';
                
                const statusText = task.status === 'completed' ? 'Completed' :
                                 task.status === 'running' ? 'Running' : 'Pending';
                
                const statusBadgeClass = task.status === 'completed' ? 'status-completed' :
                                       task.status === 'running' ? 'status-running' : 'status-pending';
                
                html += `
                    <div class="task-item ${statusClass}">
                        <div class="task-info">
                            <div class="task-name">${task.name}</div>
                            <div class="task-time">
                                <span>${formatHMS(task.elapsedSeconds)}</span>
                                ${task.calculatedDuration ? `<span>/${formatHMS(task.calculatedDuration)}</span>` : ''}
                                ${task.priority ? `<span class="prio ${task.priority}">${task.priority.toUpperCase()}</span>` : ''}
                            </div>
                        </div>
                        <div class="task-status ${statusBadgeClass}">${statusText}</div>
                        <div class="task-controls">
                            ${task.status === 'running' ? `
                                <button class="task-control-btn start" onclick="startTask('${task.id}', '${member.name}', '${shiftName}')" title="Start">‚ñ∂</button>
                                <button class="task-control-btn complete" onclick="completeTask('${task.id}', '${member.name}', '${shiftName}')" title="Complete">‚úì</button>
                            ` : task.status === 'pending' ? `
                                <button class="task-control-btn start" onclick="startTask('${task.id}', '${member.name}', '${shiftName}')" title="Start">‚ñ∂</button>
                                <button class="task-control-btn complete" onclick="completeTask('${task.id}', '${member.name}', '${shiftName}')" title="Complete">‚úì</button>
                            ` : ''}
                            <button class="task-control-btn delete" onclick="deleteTask('${task.id}', '${member.name}', '${shiftName}')" title="Delete">√ó</button>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    <div class="add-task-btn" onclick="openQuickTaskDialog('${shiftName}', '${member.name}')">
                        + Add Task
                    </div>
                </div>
            `;
            
            return html;
        }

        function openQuickTaskDialog(shiftName, memberName) {
            const taskName = prompt('Enter task name:');
            if(taskName && taskName.trim() !== '') {
                const s = shifts.find(x => x.shift === shiftName);
                const m = s.members.find(x => x.name === memberName);
                
                if(m) {
                    const newTask = {
                        ...DEFAULT_TASK,
                        id: generateTaskId(),
                        name: taskName.trim(),
                        status: 'pending',
                        createdAt: new Date().toISOString()
                    };
                    
                    if (!m.tasks) m.tasks = [];
                    m.tasks.push(newTask);
                    
                    renderShifts();
                    saveState();
                    showToast('Task added successfully');
                }
            }
        }

        function isTaskOverdue(task) {
            if(!task.name) return false;
            const dur = TASK_DURATIONS[task.name];
            if(!dur || dur <= 0) return false;
            return task.elapsedSeconds > dur;
        }

        // ==================== WELCOME SCREEN & AUTHENTICATION ====================
        
        const welcomeScreen = document.getElementById('welcome-screen');
        const welcomeLoginForm = document.getElementById('welcome-login-form');
        const welcomeUserSelect = document.getElementById('welcome-user-select');
        const welcomePassword = document.getElementById('welcome-password');
        
        // Initialize welcome screen
        function initWelcomeScreen() {
            // Show welcome screen on page load
            welcomeScreen.style.display = 'flex';
            
            // Handle welcome login form submission
            welcomeLoginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                handleWelcomeLogin();
            });
        }
        
        // Handle login from welcome screen
        function handleWelcomeLogin() {
            const username = welcomeUserSelect.value;
            const password = welcomePassword.value;
            
            if (!username) {
                alert('Please select a user');
                return;
            }
            
            // Check if user exists and password is correct
            if (USERS[username] && USERS[username].password === password) {
                // Successful login
                currentUser = { name: username, role: USERS[username].role || 'employee' };
                saveState();
                applyRoleUI();
                updateAuthUI();
                
                // Animate welcome screen exit
                welcomeScreen.style.opacity = '0';
                welcomeScreen.style.transform = 'scale(1.1)';
                
                setTimeout(() => {
                    welcomeScreen.style.display = 'none';
                    showToast(`Welcome ${username}!`);
                }, 800);
            } else {
                alert('Invalid username or password');
                welcomePassword.value = '';
            }
        }
        
        // ==================== PROGRESS CHARTS ====================

        let taskCompletionChart = null;
        let timeUtilizationChart = null;
        let taskDistributionChart = null;

        function initializeProgressCharts() {
            // Create task completion chart
            const taskCompletionCtx = document.getElementById('taskCompletionChart').getContext('2d');
            taskCompletionChart = new Chart(taskCompletionCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'In Progress', 'Not Started'],
                    datasets: [{
                        data: [30, 45, 25],
                        backgroundColor: [
                            'rgba(0, 200, 83, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(158, 158, 158, 0.8)'
                        ],
                        borderColor: [
                            'rgba(0, 200, 83, 1)',
                            'rgba(255, 193, 7, 1)',
                            'rgba(158, 158, 158, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'white',
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Create time utilization chart
            const timeUtilizationCtx = document.getElementById('timeUtilizationChart').getContext('2d');
            timeUtilizationChart = new Chart(timeUtilizationCtx, {
                type: 'bar',
                data: {
                    labels: ['Shift A', 'Shift B', 'Shift C', 'General'],
                    datasets: [{
                        label: 'Time Used (hours)',
                        data: [8.5, 7.2, 6.8, 9.1],
                        backgroundColor: 'rgba(41, 182, 246, 0.8)',
                        borderColor: 'rgba(41, 182, 246, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Time Remaining (hours)',
                        data: [2.5, 3.8, 4.2, 1.9],
                        backgroundColor: 'rgba(129, 199, 132, 0.8)',
                        borderColor: 'rgba(129, 199, 132, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: false,
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            stacked: false,
                            beginAtZero: true,
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'white',
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });

            // Create task distribution chart
            const taskDistributionCtx = document.getElementById('taskDistributionChart').getContext('2d');
            taskDistributionChart = new Chart(taskDistributionCtx, {
                type: 'pie',
                data: {
                    labels: ['Commission Greige', 'Batch Card', 'Yarn Unloading', 'Yarn Knitting', 'Yarn Beaming', 'Beam Unloading', 'Web Split', 'Return Yarn', 'Inhouse Greige'],
                    datasets: [{
                        data: [15, 12, 18, 10, 8, 7, 14, 9, 7],
                        backgroundColor: [
                            'rgba(255, 152, 0, 0.8)',
                            'rgba(57, 73, 171, 0.8)',
                            'rgba(0, 150, 136, 0.8)',
                            'rgba(103, 58, 183, 0.8)',
                            'rgba(244, 67, 54, 0.8)',
                            'rgba(96, 125, 139, 0.8)',
                            'rgba(255, 87, 34, 0.8)',
                            'rgba(121, 85, 72, 0.8)',
                            'rgba(156, 39, 176, 0.8)'
                        ],
                        borderColor: [
                            'rgba(255, 152, 0, 1)',
                            'rgba(57, 73, 171, 1)',
                            'rgba(0, 150, 136, 1)',
                            'rgba(103, 58, 183, 1)',
                            'rgba(244, 67, 54, 1)',
                            'rgba(96, 125, 139, 1)',
                            'rgba(255, 87, 34, 1)',
                            'rgba(121, 85, 72, 1)',
                            'rgba(156, 39, 176, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'white',
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value}%`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateProgressCharts() {
            // Update task completion chart
            const completedTasks = tasksHistory.length;
            const inProgressTasks = shifts.reduce((total, shift) => {
                return total + shift.members.filter(m => m.tasks && m.tasks.some(t => t.status === 'running')).length;
            }, 0);
            const notStartedTasks = shifts.reduce((total, shift) => {
                return total + shift.members.filter(m => m.tasks && m.tasks.some(t => t.status === 'pending')).length;
            }, 0);
            
            taskCompletionChart.data.datasets[0].data = [completedTasks, inProgressTasks, notStartedTasks];
            taskCompletionChart.update();

            // Update time utilization chart
            const shiftData = shifts.map(shift => {
                const totalUsed = shift.members.reduce((sum, member) => sum + (member.usedMinutes || 0), 0);
                const totalBalance = shift.members.reduce((sum, member) => sum + (member.balanceMinutes || DAILY_TIME_ALLOCATION), 0);
                return {
                    used: Math.round(totalUsed / 60 * 10) / 10,
                    balance: Math.round(totalBalance / 60 * 10) / 10
                };
            });

            timeUtilizationChart.data.datasets[0].data = shiftData.map(s => s.used);
            timeUtilizationChart.data.datasets[1].data = shiftData.map(s => s.balance);
            timeUtilizationChart.update();

            // Update task distribution chart
            const taskCounts = {
                'Commission Greige': 0,
                'Batch Card': 0,
                'Yarn Unloading': 0,
                'Yarn Knitting': 0,
                'Yarn Beaming': 0,
                'Beam Unloading': 0,
                'Web Split': 0,
                'Return Yarn': 0,
                'Inhouse Greige': 0
            };

            // Count tasks from history
            tasksHistory.forEach(task => {
                const taskName = task.task;
                if (taskName.includes('Commission Greige')) taskCounts['Commission Greige']++;
                else if (taskName.includes('Batch card')) taskCounts['Batch Card']++;
                else if (taskName.includes('Yarn Unloading')) taskCounts['Yarn Unloading']++;
                else if (taskName.includes('Yarn Issue-Knitting')) taskCounts['Yarn Knitting']++;
                else if (taskName.includes('Yarn Issue-Beaming')) taskCounts['Yarn Beaming']++;
                else if (taskName.includes('Beam Unloading')) taskCounts['Beam Unloading']++;
                else if (taskName.includes('Web Split')) taskCounts['Web Split']++;
                else if (taskName.includes('Return Yarn')) taskCounts['Return Yarn']++;
                else if (taskName.includes('Inhouse greige')) taskCounts['Inhouse Greige']++;
            });

            // Count current tasks
            shifts.forEach(shift => {
                shift.members.forEach(member => {
                    if (member.tasks) {
                        member.tasks.forEach(task => {
                            const taskName = task.name;
                            if (taskName.includes('Commission Greige')) taskCounts['Commission Greige']++;
                            else if (taskName.includes('Batch card')) taskCounts['Batch Card']++;
                            else if (taskName.includes('Yarn Unloading')) taskCounts['Yarn Unloading']++;
                            else if (taskName.includes('Yarn Issue-Knitting')) taskCounts['Yarn Knitting']++;
                            else if (taskName.includes('Yarn Issue-Beaming')) taskCounts['Yarn Beaming']++;
                            else if (taskName.includes('Beam Unloading')) taskCounts['Beam Unloading']++;
                            else if (taskName.includes('Web Split')) taskCounts['Web Split']++;
                            else if (taskName.includes('Return Yarn')) taskCounts['Return Yarn']++;
                            else if (taskName.includes('Inhouse greige')) taskCounts['Inhouse Greige']++;
                        });
                    }
                });
            });

            // Calculate percentages
            const totalTasks = Object.values(taskCounts).reduce((sum, count) => sum + count, 0);
            if (totalTasks > 0) {
                taskDistributionChart.data.datasets[0].data = Object.values(taskCounts).map(count => 
                    Math.round((count / totalTasks) * 100)
                );
                taskDistributionChart.update();
            }
        }

        // ==================== TIME MANAGEMENT FEATURES ====================

        /* ------------------ Time Management Constants ------------------ */
        const DAILY_TIME_ALLOCATION = 660; // 11 hours in minutes
        let lowBalanceAlertShown = false;

        /* ------------------ Initialize Time Management ------------------ */
        function initTimeManagement() {
            // Add event listeners for new buttons
            document.getElementById('reset-daily-times').addEventListener('click', resetDailyTimes);
            document.getElementById('daily-time-report').addEventListener('click', generateDailyTimeReport);
            document.getElementById('shift-time-report').addEventListener('click', generateShiftTimeReport);
            
            // Initialize member time tracking
            initializeMemberTimes();
        }

        /* ------------------ Initialize Member Times ------------------ */
        function initializeMemberTimes() {
            const today = new Date().toDateString();
            const lastResetDate = localStorage.getItem('lastResetDate');
            
            // Reset times if it's a new day
            if (lastResetDate !== today) {
                resetDailyTimes(true); // Silent reset
                localStorage.setItem('lastResetDate', today);
            }
            
            // Ensure all members have time tracking properties
            shifts.forEach(s => {
                s.members.forEach(m => {
                    if (m.usedMinutes === undefined) {
                        m.usedMinutes = 0;
                        m.balanceMinutes = DAILY_TIME_ALLOCATION;
                    }
                });
            });
            
            saveState();
        }

        /* ------------------ Update Member Time ------------------ */
        function updateMemberTime(memberName, shiftName, elapsedSeconds) {
            const elapsedMinutes = Math.floor(elapsedSeconds / 60);
            const s = shifts.find(x => x.shift === shiftName);
            const m = s.members.find(x => x.name === memberName);
            
            if (m) {
                m.usedMinutes = Math.min(DAILY_TIME_ALLOCATION, m.usedMinutes + elapsedMinutes);
                m.balanceMinutes = DAILY_TIME_ALLOCATION - m.usedMinutes;
                
                // Check for low balance alerts
                checkLowBalanceAlert(m);
            }
        }

        /* ------------------ Check Low Balance Alert ------------------ */
        function checkLowBalanceAlert(member) {
            if (member.balanceMinutes < 60 && !lowBalanceAlertShown) {
                showToast(`Low time balance alert: ${member.name} has only ${member.balanceMinutes} minutes remaining`);
                notify('Low Time Balance', `${member.name} has only ${member.balanceMinutes} minutes remaining`);
                lowBalanceAlertShown = true;
                
                // Reset alert after 5 minutes
                setTimeout(() => {
                    lowBalanceAlertShown = false;
                }, 300000);
            }
        }

        /* ------------------ Reset Daily Times ------------------ */
        function resetDailyTimes(silent = false) {
            if (!silent && !canPerform('admin')) {
                showToast('Permission denied: Only admin users can reset daily times');
                return;
            }
            
            shifts.forEach(s => {
                s.members.forEach(m => {
                    m.usedMinutes = 0;
                    m.balanceMinutes = DAILY_TIME_ALLOCATION;
                });
            });
            
            localStorage.setItem('lastResetDate', new Date().toDateString());
            saveState();
            renderShifts();
            
            if (!silent) {
                showToast('Daily times reset for all members');
            }
        }

        /* ------------------ Generate Daily Time Report ------------------ */
        function generateDailyTimeReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({unit:'pt', format:'a4'});
            const marginLeft = 40;
            let cursorY = 50;
            
            // Title
            doc.setFontSize(18);
            doc.setTextColor(255, 215, 0);
            doc.text('Daily Time Utilization Report', marginLeft, cursorY);
            cursorY += 24;
            
            // Date
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            const nowStr = new Date().toLocaleString();
            doc.text(`Generated: ${nowStr}`, marginLeft, cursorY);
            cursorY += 18;
            
            // Summary statistics
            let totalMembers = 0;
            let totalUsed = 0;
            let totalBalance = 0;
            
            shifts.forEach(s => {
                totalMembers += s.members.length;
                s.members.forEach(m => {
                    totalUsed += m.usedMinutes || 0;
                    totalBalance += m.balanceMinutes || DAILY_TIME_ALLOCATION;
                });
            });
            
            const utilizationRate = totalMembers > 0 ? Math.round((totalUsed / (totalMembers * DAILY_TIME_ALLOCATION)) * 100) : 0;
            
            doc.setFontSize(11);
            doc.setTextColor(50);
            doc.text(`Total Members: ${totalMembers}`, marginLeft, cursorY);
            cursorY += 14;
            doc.text(`Total Used Time: ${Math.floor(totalUsed / 60)}h ${totalUsed % 60}m`, marginLeft, cursorY);
            cursorY += 14;
            doc.text(`Total Balance Time: ${Math.floor(totalBalance / 60)}h ${totalBalance % 60}m`, marginLeft, cursorY);
            cursorY += 14;
            doc.text(`Utilization Rate: ${utilizationRate}%`, marginLeft, cursorY);
            cursorY += 20;
            
            // Table header
            const head = [['Shift', 'Member', 'Used (min)', 'Balance (min)', 'Utilization %']];
            const body = [];
            
            // Table rows
            shifts.forEach(s => {
                s.members.forEach(m => {
                    const used = m.usedMinutes || 0;
                    const balance = m.balanceMinutes || DAILY_TIME_ALLOCATION;
                    const utilization = Math.round((used / DAILY_TIME_ALLOCATION) * 100);
                    
                    body.push([
                        s.shift,
                        m.name,
                        used.toString(),
                        balance.toString(),
                        `${utilization}%`
                    ]);
                });
            });
            
            // AutoTable
            doc.autoTable({
                startY: cursorY,
                head: head,
                body: body,
                styles: { fontSize: 9, cellPadding: 6 },
                headStyles: { fillColor: [40, 48, 72], textColor: 255 },
                margin: { left: marginLeft, right: marginLeft },
                theme: 'grid'
            });
            
            // Save file
            const fileName = `Daily_Time_Report_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
        }

        /* ------------------ Generate Shift Time Report ------------------ */
        function generateShiftTimeReport() {
            const selected = shiftSelect.value;
            if (!selected) {
                alert('Please select a shift first');
                return;
            }
            
            const s = shifts.find(x => x.shift === selected);
            if (!s) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({unit:'pt', format:'a4'});
            const marginLeft = 40;
            let cursorY = 50;
            
            // Title
            doc.setFontSize(18);
            doc.setTextColor(255, 215, 0);
            doc.text(`Shift ${s.shift} Time Report`, marginLeft, cursorY);
            cursorY += 24;
            
            // Date and shift info
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            const nowStr = new Date().toLocaleString();
            doc.text(`Generated: ${nowStr}`, marginLeft, cursorY);
            cursorY += 14;
            doc.text(`Shift Time: ${s.startTime || '-'} ‚Üí ${s.endTime || '-'}`, marginLeft, cursorY);
            cursorY += 18;
            
            // Shift statistics
            let totalUsed = 0;
            let totalBalance = 0;
            
            s.members.forEach(m => {
                totalUsed += m.usedMinutes || 0;
                totalBalance += m.balanceMinutes || DAILY_TIME_ALLOCATION;
            });
            
            const avgUtilization = s.members.length > 0 ? 
                Math.round((totalUsed / (s.members.length * DAILY_TIME_ALLOCATION)) * 100) : 0;
            
            doc.setFontSize(11);
            doc.setTextColor(50);
            doc.text(`Members: ${s.members.length}`, marginLeft, cursorY);
            cursorY += 14;
            doc.text(`Total Used Time: ${Math.floor(totalUsed / 60)}h ${totalUsed % 60}m`, marginLeft, cursorY);
            cursorY += 14;
            doc.text(`Total Balance Time: ${Math.floor(totalBalance / 60)}h ${totalBalance % 60}m`, marginLeft, cursorY);
            cursorY += 14;
            doc.text(`Average Utilization: ${avgUtilization}%`, marginLeft, cursorY);
            cursorY += 20;
            
            // Table header
            const head = [['Member', 'Task', 'Used (min)', 'Balance (min)', 'Utilization %', 'Status']];
            const body = [];
            
            // Table rows
            s.members.forEach(m => {
                const used = m.usedMinutes || 0;
                const balance = m.balanceMinutes || DAILY_TIME_ALLOCATION;
                const utilization = Math.round((used / DAILY_TIME_ALLOCATION) * 100);
                const status = balance < 60 ? 'CRITICAL' : balance < 120 ? 'WARNING' : 'NORMAL';
                
                body.push([
                    m.name,
                    m.tasks ? m.tasks.map(t => t.name).join(', ') : '--',
                    used.toString(),
                    balance.toString(),
                    `${utilization}%`,
                    status
                ]);
            });
            
            // AutoTable
            doc.autoTable({
                startY: cursorY,
                head: head,
                body: body,
                styles: { fontSize: 9, cellPadding: 6 },
                headStyles: { fillColor: [40, 48, 72], textColor: 255 },
                margin: { left: marginLeft, right: marginLeft },
                theme: 'grid'
            });
            
            // Save file
            const fileName = `Shift_${s.shift}_Time_Report_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
        }

        /* ------------------ Render Time Balance Display ------------------ */
        function renderTimeBalanceDisplay(member) {
            const used = member.usedMinutes || 0;
            const balance = member.balanceMinutes || DAILY_TIME_ALLOCATION;
            const utilization = Math.round((used / DAILY_TIME_ALLOCATION) * 100);
            
            let progressClass = 'normal';
            if (balance < 60) {
                progressClass = 'critical';
            } else if (balance < 120) {
                progressClass = 'warning';
            }
            
            const progressWidth = Math.min(100, utilization);
            
            return `
                <div class="time-management">
                    <div class="time-balance">
                        <span>Used: ${Math.floor(used / 60)}h ${used % 60}m</span>
                        <span>Balance: ${Math.floor(balance / 60)}h ${balance % 60}m</span>
                    </div>
                    <div class="time-progress">
                        <div class="time-progress-bar ${progressClass}" style="width: ${progressWidth}%"></div>
                    </div>
                    <div class="time-stats">
                        <span>${utilization}% utilized</span>
                        <span>${balance < 60 ? 'LOW BALANCE!' : balance < 120 ? 'Warning' : 'Normal'}</span>
                    </div>
                </div>
            `;
        }

        // ==================== ORIGINAL CODE (with time tracking integration) ====================

        /* ------------------ Sidebar Functionality ------------------ */
        const sidebar = document.getElementById('sidebar');
        const toggleSidebar = document.getElementById('toggle-sidebar');
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');

        // Toggle sidebar collapse/expand
        toggleSidebar.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            toggleSidebar.textContent = sidebar.classList.contains('collapsed') ? '‚ñ∂' : '‚óÄ';
        });

        // Mobile menu toggle
        mobileMenuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('open');
        });

        // Check screen size and show/hide mobile menu toggle
        function checkScreenSize() {
            if (window.innerWidth <= 1024) {
                mobileMenuToggle.style.display = 'block';
                sidebar.classList.remove('collapsed');
            } else {
                mobileMenuToggle.style.display = 'none';
                sidebar.classList.remove('open');
            }
        }

        window.addEventListener('resize', checkScreenSize);
        checkScreenSize();

        /* ------------------ Clock ------------------ */
        function updateClock() {
            const now = new Date();
            const date = now.toLocaleDateString('en-GB',{weekday:'short', year:'numeric', month:'short', day:'numeric'});
            const time = now.toLocaleTimeString('en-GB');
            document.getElementById('clock').textContent = `${date} | ${time}`;
            const dc = document.getElementById('display-clock'); if(dc) dc.textContent = `${date} | ${time}`;
        }
        setInterval(updateClock,1000);
        updateClock();

        /* ------------------ Toast & Notifications ------------------ */
        const toast = document.getElementById('toast');
        function showToast(msg, timeout=3500){
            toast.textContent = msg; toast.style.display = 'block';
            setTimeout(()=>{ toast.style.display = 'none'; }, timeout);
        }
        function notify(title, body){
            try{
                if(Notification && Notification.permission === 'granted'){
                    new Notification(title, { body });
                } else if(Notification && Notification.permission !== 'denied'){
                    Notification.requestPermission().then(p => { if(p==='granted') new Notification(title,{body}); });
                }
            }catch(e){}
            // sound
            const audio = new Audio('data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAA...'); // tiny placeholder silent base64 - production: replace with real beep
            try{ audio.play().catch(()=>{}); }catch(e){}
        }

        /* -------------------------- Data & Persistence ------------------ */
        /* Default support list */
        const SUPPORT_MEMBERS = [
            "Lahiru","Chinthaka","Tharindu","Chathura","Lakshitha","Thusitha","Supun","Chamara",
            "Sujith","Kumara","Sasith","Piyum","Rama","Madusanka","Anjula","Chirantha"
        ];

        /* Default task durations (secs) */
        const TASK_DURATIONS = {
            "Commission Greige GRN": 1260,
            "Batch card Issue": 7440,
            "Yarn Unloading & GRN": 2160,
            "Yarn Issue-Knitting": 2610,
            "Yarn Issue-Beaming": 1650,
            "Beam Unloading & GRN": 4560,
            "Web Split & Sample Cutting": 1080,
            "Return Yarn Taking": 1470,
            "Inhouse greige taking": 4650
        };

        /* Users: saved in localStorage as 'shift_manager_users_v1'
        Default accounts: Thushara, Thusitha, Supun, Tharindu with default password '1234'.
        Structure: { "<Name>": { password: "<plain>", role: "employee" } }
        */
        const DEFAULT_USERS = {
            "Thushara": { password: "1234", role: "admin" },
            "Thusitha":  { password: "1234", role: "supervisor" },
            "Supun":     { password: "1234", role: "employee" },
            "Tharindu":  { password: "1234", role: "admin" }
        };

        function loadUsers(){
            try{
                const raw = localStorage.getItem('shift_manager_users_v1');
                if(raw) return JSON.parse(raw);
            }catch(e){}
            // first-run: return defaults
            return Object.assign({}, DEFAULT_USERS);
        }
        function saveUsers(users){
            try{
                localStorage.setItem('shift_manager_users_v1', JSON.stringify(users));
            }catch(e){}
        }
        let USERS = loadUsers();

        /* Initial shifts data */
        let shifts = [
            { shift:"A", startTime:"06:00", endTime:"14:00", members:[ {name:"Kumara"}, {name:"Sujith"}, {name:"Chamara"} ] },
            { shift:"B", startTime:"14:00", endTime:"22:00", members:[ {name:"Madhusanka"}, {name:"Anjula"}, {name:"Hirantha"} ] },
            { shift:"C", startTime:"22:00", endTime:"06:00", members:[ {name:"Sasith"}, {name:"Piyum"}, {name:"Rama Krishnan"} ] },
            { shift:"General", startTime:"09:00", endTime:"17:00", members:[ {name:"Chathura"}, {name:"Lakshitha"}, {name:"Tharindu"},{name:"Chinthaka"},{name:"Lahiru"},{name:"Shiyan"} ] }
        ];

        /* Expanded member properties (timers/state) will be attached when loaded */
        let tasksHistory = []; // persisted history
        let currentUser = { name: null, role: 'employee' };

        /* load from localStorage if exists */
        function loadState(){
            try{
                const raw = localStorage.getItem('shift_manager_state_v2');
                if(raw){
                    const parsed = JSON.parse(raw);
                    if(parsed.shifts) shifts = parsed.shifts;
                    if(parsed.tasksHistory) tasksHistory = parsed.tasksHistory;
                    if(parsed.currentUser) currentUser = parsed.currentUser;
                }
            }catch(e){}
            // ensure members have required fields
            shifts.forEach(s=>{
                s.members = s.members.map(m => Object.assign({
                    task:'', startTime:null, elapsed:0, isRunning:false, support:null, completedBy:null, attendance:'unmarked', _startedAt:null, priority:'', leave: null,
                    usedMinutes: 0, balanceMinutes: DAILY_TIME_ALLOCATION,
                    tasks: [] // Add tasks array for multiple tasks
                }, m));
            });
        }
        loadState();

        /* auto-save */
        function saveState(){
            try{
                const payload = { shifts, tasksHistory, currentUser };
                localStorage.setItem('shift_manager_state_v2', JSON.stringify(payload));
                document.getElementById('autosave-ind').textContent = 'ON';
                document.getElementById('cloud-status').textContent = 'Local only';
            }catch(e){ console.error(e); document.getElementById('autosave-ind').textContent = 'OFF'; }
        }
        setInterval(saveState, 3000);

        /* ------------------ UI Elements refs ------------------ */
        const shiftSelect = document.getElementById('shift-select');
        const memberSelect = document.getElementById('member-select');
        const taskSelect = document.getElementById('task-select');
        const customTaskInput = document.getElementById('custom-task');
        const prioritySelect = document.getElementById('priority-select');
        const shiftContainer = document.getElementById('shift-container');
        const supportSelect = document.getElementById('support-select');
        const displayBtn = document.getElementById('display-btn');
        const overlay = document.getElementById('display-overlay');
        const displayContent = document.getElementById('display-content');
        const exitDisplay = document.getElementById('exit-display');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const csvExportBtn = document.getElementById('csv-export-btn');
        const dailyChartBtn = document.getElementById('daily-chart-btn');
        const progressChartBtn = document.getElementById('progress-chart-btn');
        const chartModal = document.getElementById('chart-modal');
        const closeChartBtn = document.getElementById('close-chart');
        const searchInput = document.getElementById('search-input');
        const filterSelect = document.getElementById('filter-select');
        const qrBtn = document.getElementById('qr-btn');
        const qrModal = document.getElementById('qr-modal');
        const qrMemberSelect = document.getElementById('qr-member-select');
        const qrOutput = document.getElementById('qr-output');
        const qrScanner = document.getElementById('qr-scanner');
        const generateQrBtn = document.getElementById('generate-qr');
        const scanQrBtn = document.getElementById('scan-qr');
        const qrClose = document.getElementById('qr-close');
        const displayClock = document.getElementById('display-clock');
        const dashboardBtn = document.getElementById('dashboard-btn');
        const dashboardModal = document.getElementById('dashboard-modal');
        const loginBtn = document.getElementById('login-btn');
        const loginModal = document.getElementById('login-modal');
        const loginClose = document.getElementById('login-close');
        const loginSubmit = document.getElementById('login-submit');
        const loginNameSelect = document.getElementById('login-name');
        const loginPassword = document.getElementById('login-password');
        const userRoleEl = document.getElementById('user-role');
        const shiftTimeDisplay = document.getElementById('shift-time-display');
        const changePassBtn = document.getElementById('change-pass-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const changePassModal = document.getElementById('change-pass-modal');
        const cpClose = document.getElementById('cp-close');
        const cpSubmit = document.getElementById('cp-submit');
        const cpCurr = document.getElementById('cp-current');
        const cpNew = document.getElementById('cp-new');
        const cpConfirm = document.getElementById('cp-confirm');
        const cpMsg = document.getElementById('cp-msg');

        // Time Calculator Elements
        const timeCalcModal = document.getElementById('time-calc-modal');
        const calcCancel = document.getElementById('calc-cancel');
        const calcApply = document.getElementById('calc-apply');
        const timeIndicator = document.getElementById('time-indicator');
        const calcTaskTitle = document.getElementById('calc-task-title');
        const globalWarning = document.getElementById('global-warning');
        const quantityInput = document.getElementById('quantity-input');
        const quantityLabel = document.getElementById('quantity-label');
        const taskInputs = document.getElementById('task-inputs');
        const taskReference = document.getElementById('task-reference');

        // Leave Management Elements
        const leaveModal = document.getElementById('leave-modal');
        const manageLeaveBtn = document.getElementById('manage-leave-btn');
        const leaveMemberSelect = document.getElementById('leave-member-select');
        const leaveTypeSelect = document.getElementById('leave-type');
        const leaveStartTime = document.getElementById('leave-start-time');
        const leaveEndTime = document.getElementById('leave-end-time');
        const leaveReason = document.getElementById('leave-reason');
        const leaveSummary = document.getElementById('leave-summary');
        const leaveApplyBtn = document.getElementById('leave-apply');
        const leaveCancelBtn = document.getElementById('leave-cancel');
        const clearLeaveBtn = document.getElementById('clear-leave-btn');

        /* ------------------ Task Time Calculation Functions ------------------ */
        let currentTaskType = '';
        let calculatedTime = 0;

        // Time thresholds for warnings
        const TIME_THRESHOLDS = {
            WARNING: 120, // 2 hours in minutes
            CRITICAL: 180 // 3 hours in minutes
        };

        // Initialize calculator event listeners
        function initTimeCalculator() {
            // Input event listeners for real-time calculation
            quantityInput.addEventListener('input', calculateAndDisplayTime);
            
            // Modal control buttons
            calcCancel.addEventListener('click', () => {
                timeCalcModal.style.display = 'none';
            });
            
            calcApply.addEventListener('click', applyCalculatedTime);
        }

        // Calculate total time and update display
        function calculateAndDisplayTime() {
            const quantity = parseFloat(quantityInput.value) || 1;
            const taskResult = calculateTaskTime(currentTaskType, quantity);
            const totalTime = taskResult.totalTime;
            const totalSeconds = totalTime * 60;
            
            // Update display with appropriate warning level
            let indicatorClass = 'normal';
            let indicatorText = `Estimated Time: ${totalTime.toFixed(1)} minutes (${taskResult.details})`;
            
            if (totalTime > TIME_THRESHOLDS.CRITICAL) {
                indicatorClass = 'critical';
                indicatorText = `‚ö†Ô∏è CRITICAL: ${totalTime.toFixed(1)} minutes (${taskResult.details}) - Exceeds 3 hours`;
                showGlobalWarning();
            } else if (totalTime > TIME_THRESHOLDS.WARNING) {
                indicatorClass = 'warning';
                indicatorText = `‚ö†Ô∏è WARNING: ${totalTime.toFixed(1)} minutes (${taskResult.details}) - Exceeds 2 hours`;
                showGlobalWarning();
            } else {
                hideGlobalWarning();
            }
            
            timeIndicator.className = `time-indicator ${indicatorClass}`;
            timeIndicator.textContent = indicatorText;
            
            return { totalSeconds, calculationDetails: taskResult };
        }

        // Show global warning indicator
        function showGlobalWarning() {
            globalWarning.style.display = 'flex';
        }

        // Hide global warning indicator
        function hideGlobalWarning() {
            globalWarning.style.display = 'none';
        }

        // Open time calculator for specific task type
        function openTimeCalculator(taskType) {
            currentTaskType = taskType;
            const task = TASK_TIME_CONSTANTS[taskType];
            
            if (!task) {
                // For tasks without predefined calculations
                completeTaskAssignment();
                return;
            }
            
            // Set modal title
            calcTaskTitle.textContent = `${taskType} Calculation`;
            
            // Update input label and default value
            quantityLabel.textContent = `Number of ${task.unit}:`;
            quantityInput.value = task.normalQty;
            
            // Update reference table
            const referenceTable = taskReference.querySelector('div');
            referenceTable.innerHTML = `
                <div><strong>Normal Qty</strong></div>
                <div><strong>Time</strong></div>
                <div><strong>Additional Qty Time</strong></div>
                <div>${task.normalQty} ${task.unit}</div>
                <div>${task.normalTime} min</div>
                <div>${task.additionalTime} min/${task.unit}</div>
            `;
            
            // Calculate initial values
            calculateAndDisplayTime();
            
            // Show the modal
            timeCalcModal.style.display = 'flex';
        }

        // Apply calculated time to task
        function applyCalculatedTime() {
            const quantity = parseFloat(quantityInput.value) || 1;
            const result = calculateAndDisplayTime();
            const totalSeconds = result.totalSeconds;
            const calculationDetails = result.calculationDetails;
            
            // Store the calculated time for assignment
            window.calculatedTaskTime = totalSeconds;
            window.calculatedTaskDescription = `${currentTaskType} (${quantity} ${calculationDetails.unit})`;
            window.calculatedTaskDetails = {
                quantity: quantity,
                unit: calculationDetails.unit,
                totalTime: calculationDetails.totalTime.toFixed(1)
            };
            
            timeCalcModal.style.display = 'none';
            showToast(`Task assigned: ${window.calculatedTaskDescription}`);
            
            // Continue with assignment
            completeTaskAssignment();
        }

        /* ------------------ Leave Management Functions ------------------ */
        function initLeaveManagement() {
            // Open leave modal
            manageLeaveBtn.addEventListener('click', () => {
                populateLeaveMemberOptions();
                resetLeaveForm();
                leaveModal.style.display = 'flex';
            });
            
            // Cancel leave modal
            leaveCancelBtn.addEventListener('click', () => {
                leaveModal.style.display = 'none';
            });
            
            // Apply leave
            leaveApplyBtn.addEventListener('click', applyLeave);
            
            // Clear leave
            clearLeaveBtn.addEventListener('click', clearLeave);
            
            // Update leave summary when inputs change
            leaveMemberSelect.addEventListener('change', updateLeaveSummary);
            leaveTypeSelect.addEventListener('change', updateLeaveSummary);
            leaveStartTime.addEventListener('change', updateLeaveSummary);
            leaveEndTime.addEventListener('change', updateLeaveSummary);
            leaveReason.addEventListener('input', updateLeaveSummary);
        }

        function populateLeaveMemberOptions() {
            leaveMemberSelect.innerHTML = '<option value="">Select Member</option>';
            shifts.forEach(s => {
                s.members.forEach(m => {
                    const option = document.createElement('option');
                    option.value = `${s.shift}::${m.name}`;
                    option.textContent = `${s.shift} - ${m.name}`;
                    leaveMemberSelect.appendChild(option);
                });
            });
        }

        function resetLeaveForm() {
            leaveMemberSelect.value = '';
            leaveTypeSelect.value = 'short_leave';
            leaveStartTime.value = '';
            leaveEndTime.value = '';
            leaveReason.value = '';
            leaveSummary.textContent = 'Select a member and set leave times';
        }

        function updateLeaveSummary() {
            const selectedValue = leaveMemberSelect.value;
            const type = leaveTypeSelect.value;
            const start = leaveStartTime.value;
            const end = leaveEndTime.value;
            const reason = leaveReason.value;
            
            if (!selectedValue) {
                leaveSummary.textContent = 'Select a member and set leave times';
                return;
            }
            
            const [shiftName, memberName] = selectedValue.split('::');
            const shift = shifts.find(s => s.shift === shiftName);
            const member = shift.members.find(m => m.name === memberName);
            
            if (!member) {
                leaveSummary.textContent = 'Member not found';
                return;
            }
            
            let summary = `Apply ${getLeaveTypeDisplay(type)} to ${memberName}`;
            
            if (start && end) {
                const duration = calculateLeaveDuration(start, end);
                summary += ` from ${start} to ${end} (${duration})`;
            }
            
            if (reason) {
                summary += ` - Reason: ${reason}`;
            }
            
            if (member.leave) {
                summary += `\n\n‚ö†Ô∏è Current Leave: ${getLeaveTypeDisplay(member.leave.type)} from ${member.leave.startTime} to ${member.leave.endTime}`;
            }
            
            leaveSummary.textContent = summary;
        }

        function getLeaveTypeDisplay(type) {
            switch(type) {
                case 'short_leave': return 'Short Leave';
                case 'half_day': return 'Half Day';
                case 'full_day': return 'Full Day';
                default: return 'Leave';
            }
        }

        function calculateLeaveDuration(start, end) {
            if (!start || !end) return '';
            
            const startTime = new Date(`2000-01-01T${start}`);
            const endTime = new Date(`2000-01-01T${end}`);
            
            if (endTime <= startTime) {
                return 'Invalid time range';
            }
            
            const diffMs = endTime - startTime;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            
            if (diffHours === 0) {
                return `${diffMinutes} minutes`;
            } else if (diffMinutes === 0) {
                return `${diffHours} hours`;
            } else {
                return `${diffHours}h ${diffMinutes}m`;
            }
        }

        function applyLeave() {
            const selectedValue = leaveMemberSelect.value;
            const type = leaveTypeSelect.value;
            const start = leaveStartTime.value;
            const end = leaveEndTime.value;
            const reason = leaveReason.value;
            
            if (!selectedValue || !start || !end) {
                showToast('Please select a member and set both start and end times');
                return;
            }
            
            const [shiftName, memberName] = selectedValue.split('::');
            const shift = shifts.find(s => s.shift === shiftName);
            const member = shift.members.find(m => m.name === memberName);
            
            if (!member) {
                showToast('Member not found');
                return;
            }
            
            // Validate time range
            const startTime = new Date(`2000-01-01T${start}`);
            const endTime = new Date(`2000-01-01T${end}`);
            
            if (endTime <= startTime) {
                showToast('End time must be after start time');
                return;
            }
            
            // Apply leave to member
            member.leave = {
                type: type,
                startTime: start,
                endTime: end,
                reason: reason || '',
                appliedAt: new Date().toISOString()
            };
            
            // If member has running tasks, pause them
            if (member.tasks) {
                member.tasks.forEach(task => {
                    if (task.status === 'running') {
                        task.status = 'pending';
                        task.elapsedSeconds = Math.floor((Date.now() - task.startTime) / 1000);
                        task.startTime = null;
                    }
                });
            }
            
            showToast(`${getLeaveTypeDisplay(type)} applied to ${memberName} from ${start} to ${end}`);
            renderShifts();
            saveState();
            leaveModal.style.display = 'none';
        }

        function clearLeave() {
            const selectedValue = leaveMemberSelect.value;
            
            if (!selectedValue) {
                showToast('Please select a member first');
                return;
            }
            
            const [shiftName, memberName] = selectedValue.split('::');
            const shift = shifts.find(s => s.shift === shiftName);
            const member = shift.members.find(m => m.name === memberName);
            
            if (!member) {
                showToast('Member not found');
                return;
            }
            
            if (!member.leave) {
                showToast('No active leave for this member');
                return;
            }
            
            member.leave = null;
            showToast(`Leave cleared for ${memberName}`);
            renderShifts();
            saveState();
            updateLeaveSummary();
        }

        /* populate support dropdown */
        function populateSupportOptions(){
            supportSelect.innerHTML = '<option value="">Select Support Member</option>';
            SUPPORT_MEMBERS.forEach(name => {
                const o = document.createElement('option'); o.value = name; o.textContent = name;
                supportSelect.appendChild(o);
            });
        }
        populateSupportOptions();

        /* populate shift dropdown */
        function populateShiftOptions(){
            shiftSelect.innerHTML = '<option value="">Select Shift</option>';
            shifts.forEach(s=>{
                const opt = document.createElement('option'); opt.value = s.shift; opt.textContent = `Shift ${s.shift}`;
                shiftSelect.appendChild(opt);
            });
            if(shifts.length>0){
                shiftSelect.value = shifts[0].shift;
                updateMemberDropdown();
                renderShifts();
                showSelectedShiftTime();
            }
        }
        populateShiftOptions();

        /* update selected shift time display */
        function showSelectedShiftTime(){
            const sel = shiftSelect.value;
            const s = shifts.find(x=>x.shift===sel);
            if(!s){ shiftTimeDisplay.textContent = '-'; return; }
            shiftTimeDisplay.textContent = `${s.startTime||'-'} ‚Äî ${s.endTime||'-'}`;
        }

        /* shift change */
        shiftSelect.addEventListener('change', ()=>{ updateMemberDropdown(); renderShifts(); showSelectedShiftTime(); });

        /* update member dropdown based on selected shift */
        function updateMemberDropdown(){
            memberSelect.innerHTML = '<option value="">Select Member</option>';
            qrMemberSelect.innerHTML = '<option value="">Select Member</option>';
            const selected = shiftSelect.value; if(!selected) return;
            const sObj = shifts.find(s=>s.shift===selected); if(!sObj) return;
            sObj.members.forEach(m=>{
                const o=document.createElement('option'); o.value=m.name; o.textContent=m.name;
                memberSelect.appendChild(o);
                const o2 = document.createElement('option'); o2.value = `${sObj.shift}::${m.name}`; o2.textContent = `${sObj.shift} ‚Äî ${m.name}`;
                qrMemberSelect.appendChild(o2);
            });
        }

        /* custom task toggle */
        taskSelect.addEventListener('change', ()=> { customTaskInput.style.display = (taskSelect.value === 'OTHER') ? 'inline-block' : 'none'; });

        /* ------------------ Assign / Add / Support ------------------ */
        function ensureMemberFields(m){
            m.task = m.task || '';
            m.elapsed = Number(m.elapsed||0);
            m.startTime = m.startTime || null;
            m.isRunning = !!m.isRunning;
            m.support = m.support || null;
            m.completedBy = m.completedBy || null;
            m.attendance = m.attendance || 'unmarked';
            m._startedAt = m._startedAt ? new Date(m._startedAt) : null;
            m.priority = m.priority || '';
            m.leave = m.leave || null;
            m.usedMinutes = m.usedMinutes || 0;
            m.balanceMinutes = m.balanceMinutes || DAILY_TIME_ALLOCATION;
            if (!m.tasks) m.tasks = [];
        }

        // Modified assignTask function is already defined above

        document.getElementById('assign-btn').addEventListener('click', assignTask);

        function addEmployee(){
            if(!canPerform('addEmployee')) { showToast('Permission denied'); return; }
            const shiftVal = shiftSelect.value; const nameInput = document.getElementById('new-emp-name'); const name = nameInput ? nameInput.value.trim() : '';
            if(!shiftVal){ alert('Select a shift first'); return; }
            if(!name){ const promptName = prompt('Enter new employee name:'); if(!promptName) return; pushNewEmployee(shiftVal, promptName.trim()); } else { pushNewEmployee(shiftVal, name); nameInput.value = ''; }
        }
        document.getElementById('add-emp-btn').addEventListener('click', addEmployee);
        function pushNewEmployee(shiftVal, name){
            const s = shifts.find(x=>x.shift===shiftVal);
            s.members.push({ 
                name, 
                task:'', 
                startTime:null, 
                elapsed:0, 
                isRunning:false, 
                support:null, 
                completedBy:null, 
                attendance:'unmarked', 
                _startedAt:null, 
                priority:'', 
                leave: null,
                usedMinutes: 0,
                balanceMinutes: DAILY_TIME_ALLOCATION,
                tasks: []
            });
            updateMemberDropdown(); renderShifts(); renderDisplay(); saveState();
        }

        /* assign support to selected member */
        function assignSupportToSelected(){
            if(!canPerform('assign')) { showToast('Permission denied'); return; }
            const shiftVal = shiftSelect.value;
            const memberVal = memberSelect.value;
            const supportVal = supportSelect.value;
            if(!shiftVal || !memberVal || !supportVal){ alert('Select shift, member and support member'); return; }
            if(supportVal === memberVal){ alert('Support member cannot be same as the main member'); return; }
            const s = shifts.find(x=>x.shift===shiftVal);
            const m = s.members.find(x=>x.name===memberVal);
            if(!m || !m.tasks || m.tasks.length === 0){ alert('Choose a member with assigned tasks'); return; }
            // Assign support to all pending/running tasks
            m.tasks.forEach(task => {
                if (task.status === 'pending' || task.status === 'running') {
                    task.support = supportVal;
                }
            });
            showToast(`Support ${supportVal} assigned to ${m.name}`);
            renderShifts(); renderDisplay(); saveState();
        }
        document.getElementById('assign-support-btn').addEventListener('click', assignSupportToSelected);

        /* support completes the task */
        function supportComplete(taskId, memberName, shiftName){
            if(!canPerform('assign')) { showToast('Permission denied'); return; }
            const s = shifts.find(x=>x.shift===shiftName);
            const m = s.members.find(x=>x.name===memberName);
            if(!m || !m.tasks){ alert('No tasks assigned'); return; }
            
            const task = m.tasks.find(t => t.id === taskId);
            if(!task || !task.support){ alert('No support assigned to this task'); return; }
            
            if(task.status === 'running'){
                task.elapsedSeconds = Math.floor((Date.now() - task.startTime) / 1000);
            }
            task.status = 'completed';
            task.startTime = null;
            task.completedBy = task.support;
            task.endTime = new Date().toISOString();
            task.completedAt = new Date().toISOString();
            
            tasksHistory.push({
                shift: shiftName,
                member: memberName,
                task: task.name || '--',
                start: task.createdAt ? new Date(task.createdAt).toISOString() : new Date().toISOString(),
                end: new Date().toISOString(),
                durationSecs: task.elapsedSeconds || 0,
                support: task.support,
                completedBy: task.support,
                attendance: m.attendance || 'unmarked',
                priority: task.priority || ''
            });
            
            task.support = null;
            showToast(`Task for ${m.name} completed by support ${task.completedBy}`);
            renderShifts(); renderDisplay(); saveState();
        }

        /* attendance marking */
        function markAttendance(shiftName, memberName, status){
            if(!canPerform('markAttendance')) { showToast('Permission denied'); return; }
            const s = shifts.find(x=>x.shift===shiftName);
            const m = s.members.find(x=>x.name===memberName);
            if(!m) return;
            m.attendance = status; // 'present' | 'absent' | 'unmarked'
            renderShifts(); renderDisplay(); saveState();
        }

        /* ------------------ Modified Timer Function ------------------ */
        // Replace the existing setInterval function with this updated version
        setInterval(()=>{ 
            shifts.forEach(s=>{
                s.members.forEach(m=>{
                    if(m.tasks) {
                        m.tasks.forEach(task => {
                            if(task.status === 'running' && task.startTime){
                                task.elapsedSeconds = Math.floor( (Date.now() - task.startTime) / 1000 );
                            }
                        });
                    }
                });
            });
            
            renderShifts(false);
            renderDisplay();
            
            // Check for task time limits
            checkTaskTimeLimits();
            
            // Update progress charts every 5 seconds
            if (Date.now() % 5000 < 1000) {
                updateProgressCharts();
            }
            
            // Check for overdue tasks
            shifts.forEach(s=>{
                s.members.forEach(m=>{
                    if(m.tasks) {
                        m.tasks.forEach(task => {
                            if(task.status === 'running' && isTaskOverdue(task) && !task._notifiedOverdue){
                                task._notifiedOverdue = true;
                                notify('Task overdue', `${m.name} overdue for ${task.name}`);
                                showToast(`${m.name} is overdue on ${task.name}`);
                            }
                        });
                    }
                });
            });
        },1000);

        /* format time (digit-by-digit safe) */
        function formatHMS(sec){
            sec = Number(sec) || 0;
            const h = Math.floor(sec/3600);
            const m = Math.floor((sec%3600)/60);
            const s = sec%60;
            const hh = String(h).padStart(2,'0');
            const mm = String(m).padStart(2,'0');
            const ss = String(s).padStart(2,'0');
            return `${hh}:${mm}:${ss}`;
        }

        /* overdue check */
        function isOverdue(taskName, elapsedSeconds){
            if(!taskName) return false;
            const dur = TASK_DURATIONS[taskName];
            if(!dur || dur <= 0) return false;
            return elapsedSeconds > dur;
        }

        /* ------------------ Modified Render Shifts Function ------------------ */
        function renderShifts(doSave = true){
            const searchTerm = searchInput.value.toLowerCase();
            const filterVal = filterSelect.value;
            
            shiftContainer.innerHTML = '';
            
            shifts.forEach(s => {
                const shiftCard = document.createElement('div');
                shiftCard.className = 'shift';
                
                const h2 = document.createElement('h2');
                h2.innerHTML = `Shift ${s.shift} <span class="muted" style="font-size:0.9rem;">${s.startTime||'-'} ‚Üí ${s.endTime||'-'}</span>`;
                shiftCard.appendChild(h2);
                
                const ul = document.createElement('ul');
                
                s.members.forEach(m => {
                    ensureMemberFields(m);
                    
                    // Filter logic
                    let showMember = true;
                    
                    // Search filter
                    if (searchTerm && !m.name.toLowerCase().includes(searchTerm) && 
                        !(m.tasks && m.tasks.some(t => t.name.toLowerCase().includes(searchTerm)))) {
                        showMember = false;
                    }
                    
                    // Additional filters
                    if (filterVal) {
                        switch(filterVal) {
                            case 'overdue':
                                showMember = m.tasks && m.tasks.some(t => isTaskOverdue(t) && t.status === 'running');
                                break;
                            case 'running':
                                showMember = m.tasks && m.tasks.some(t => t.status === 'running');
                                break;
                            case 'unassigned':
                                showMember = !m.tasks || m.tasks.length === 0;
                                break;
                            case 'onleave':
                                showMember = m.leave !== null;
                                break;
                            case 'lowbalance':
                                showMember = (m.balanceMinutes || DAILY_TIME_ALLOCATION) < 120;
                                break;
                        }
                    }
                    
                    if (!showMember) return;
                    
                    const li = document.createElement('li');
                    
                    // Add warning dot for overdue tasks
                    const hasOverdue = m.tasks && m.tasks.some(t => isTaskOverdue(t) && t.status === 'running');
                    if (hasOverdue) {
                        li.style.borderLeftColor = 'var(--warn)';
                    }
                    
                    const left = document.createElement('div');
                    left.className = 'left';
                    
                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'name';
                    if (hasOverdue) {
                        const warnDot = document.createElement('div');
                        warnDot.className = 'warning-dot blink';
                        left.appendChild(warnDot);
                    }
                    nameDiv.textContent = m.name;
                    left.appendChild(nameDiv);
                    
                    // Add leave badge if applicable
                    if (m.leave) {
                        const leaveBadge = document.createElement('div');
                        leaveBadge.className = 'leave-badge';
                        leaveBadge.innerHTML = `‚è±Ô∏è ${m.leave.startTime} - ${m.leave.endTime}`;
                        left.appendChild(leaveBadge);
                    }
                    
                    const right = document.createElement('div');
                    right.style.display = 'flex';
                    right.style.alignItems = 'center';
                    right.style.gap = '8px';
                    
                    const timeDiv = document.createElement('div');
                    timeDiv.className = 'time';
                    
                    // Calculate total time for all tasks
                    let totalElapsed = 0;
                    if (m.tasks) {
                        m.tasks.forEach(task => {
                            totalElapsed += task.elapsedSeconds || 0;
                        });
                    }
                    timeDiv.textContent = formatHMS(totalElapsed);
                    right.appendChild(timeDiv);
                    
                    const startEndDiv = document.createElement('div');
                    startEndDiv.className = 'start-end';
                    
                    // Attendance buttons
                    const presentBtn = document.createElement('button');
                    presentBtn.className = 'small';
                    presentBtn.textContent = 'Present';
                    presentBtn.style.background = m.attendance === 'present' ? 'var(--good)' : '#2b3e66';
                    presentBtn.onclick = () => markAttendance(s.shift, m.name, 'present');
                    
                    const absentBtn = document.createElement('button');
                    absentBtn.className = 'small';
                    absentBtn.textContent = 'Absent';
                    absentBtn.style.background = m.attendance === 'absent' ? 'var(--bad)' : '#2b3e66';
                    absentBtn.onclick = () => markAttendance(s.shift, m.name, 'absent');
                    
                    startEndDiv.appendChild(presentBtn);
                    startEndDiv.appendChild(absentBtn);
                    right.appendChild(startEndDiv);
                    
                    li.appendChild(left);
                    li.appendChild(right);
                    ul.appendChild(li);
                    
                    // Add task list for this member
                    const taskListHTML = renderTaskList(m, s.shift);
                    const taskListDiv = document.createElement('div');
                    taskListDiv.innerHTML = taskListHTML;
                    ul.appendChild(taskListDiv);
                    
                    // Add time balance display
                    const timeBalanceHTML = renderTimeBalanceDisplay(m);
                    const timeBalanceDiv = document.createElement('div');
                    timeBalanceDiv.innerHTML = timeBalanceHTML;
                    ul.appendChild(timeBalanceDiv);
                });
                
                if (ul.children.length === 0) {
                    const emptyLi = document.createElement('li');
                    emptyLi.innerHTML = '<div class="muted" style="text-align:center;width:100%;">No members match the current filter</div>';
                    ul.appendChild(emptyLi);
                }
                
                shiftCard.appendChild(ul);
                shiftContainer.appendChild(shiftCard);
            });
            
            if(doSave) saveState();
        }

        /* ---------------- Display overlay ---------------- */
        displayBtn.addEventListener('click', ()=> openDisplay());
        exitDisplay.addEventListener('click', ()=> closeDisplay());
        function openDisplay(){
            overlay.style.display = 'block';
            if(overlay.requestFullscreen){ overlay.requestFullscreen().catch(()=>{}); }
            renderDisplay();
        }
        function closeDisplay(){
            overlay.style.display = 'none';
            if(document.fullscreenElement){ document.exitFullscreen().catch(()=>{}); }
        }
        function renderDisplay(){
            if(overlay.style.display === 'none' || overlay.style.display === '') return;
            displayContent.innerHTML = '';
            shifts.forEach(s=>{
                const hasTasks = s.members.some(m => m.tasks && m.tasks.length > 0);
                if(!hasTasks) return;
                
                const card = document.createElement('div'); card.className='display-card';
                const h = document.createElement('h3'); h.textContent = `Shift ${s.shift}`; card.appendChild(h);
                
                s.members.forEach(m=>{
                    if(!m.tasks || m.tasks.length === 0) return;
                    
                    const row = document.createElement('div');
                    row.style.display='flex'; 
                    row.style.justifyContent='space-between'; 
                    row.style.alignItems='flex-start';
                    row.style.padding='12px 8px'; 
                    row.style.borderBottom='1px solid rgba(255,255,255,0.04)';
                    row.style.flexDirection = 'column';
                    
                    const left = document.createElement('div');
                    left.style.width = '100%';
                    const nm = document.createElement('div'); 
                    nm.style.fontWeight='800'; 
                    nm.textContent = m.name;
                    left.appendChild(nm);
                    
                    // Display tasks for this member
                    m.tasks.forEach(task => {
                        const taskRow = document.createElement('div');
                        taskRow.style.display = 'flex';
                        taskRow.style.justifyContent = 'space-between';
                        taskRow.style.alignItems = 'center';
                        taskRow.style.padding = '4px 0';
                        taskRow.style.width = '100%';
                        
                        const taskLeft = document.createElement('div');
                        taskLeft.style.flex = '1';
                        const taskName = document.createElement('div'); 
                        taskName.textContent = task.name;
                        taskName.style.fontStyle = 'italic';
                        taskName.style.opacity = '0.95';
                        taskLeft.appendChild(taskName);
                        
                        const taskRight = document.createElement('div');
                        taskRight.style.textAlign = 'right';
                        const taskTime = document.createElement('div'); 
                        taskTime.style.fontWeight='600'; 
                        taskTime.style.color='var(--gold)'; 
                        taskTime.style.fontFamily='monospace'; 
                        taskTime.textContent = formatHMS(task.elapsedSeconds || 0);
                        taskRight.appendChild(taskTime);
                        
                        const taskStatus = document.createElement('div'); 
                        taskStatus.style.marginTop='4px';
                        taskStatus.className = 'att ' + (task.status === 'completed' ? 'present' : 
                                              task.status === 'running' ? 'present' : 'unmarked');
                        taskStatus.textContent = task.status.toUpperCase();
                        taskRight.appendChild(taskStatus);
                        
                        if(isTaskOverdue(task)){
                            const warn = document.createElement('div'); 
                            warn.style.color = 'var(--warn)'; 
                            warn.style.fontWeight='700'; 
                            warn.style.fontSize='0.8rem';
                            warn.textContent = 'OVERDUE';
                            taskRight.appendChild(warn);
                        }
                        
                        taskRow.appendChild(taskLeft);
                        taskRow.appendChild(taskRight);
                        left.appendChild(taskRow);
                    });
                    
                    const right = document.createElement('div'); 
                    right.style.textAlign='right';
                    right.style.marginTop = '8px';
                    right.style.width = '100%';
                    
                    const att = document.createElement('div'); 
                    att.style.marginTop='6px';
                    att.className = 'att ' + (m.attendance||'unmarked');
                    att.textContent = (m.attendance==='present'?'Present':m.attendance==='absent'?'Absent':'Unmarked');
                    right.appendChild(att);
                    
                    if(m.leave){ 
                        const leave = document.createElement('div'); 
                        leave.style.fontSize='0.9rem'; 
                        leave.style.opacity='0.9'; 
                        leave.style.marginTop='6px'; 
                        leave.style.color = 'var(--leave)';
                        leave.textContent = `Leave: ${m.leave.startTime} - ${m.leave.endTime}`; 
                        right.appendChild(leave); 
                    }
                    
                    // Add time balance to display
                    const timeBalance = document.createElement('div');
                    timeBalance.style.fontSize='0.85rem';
                    timeBalance.style.opacity='0.9';
                    timeBalance.style.marginTop='6px';
                    const used = m.usedMinutes || 0;
                    const balance = m.balanceMinutes || DAILY_TIME_ALLOCATION;
                    timeBalance.textContent = `Time: ${Math.floor(used/60)}h${used%60}m / ${Math.floor(balance/60)}h${balance%60}m`;
                    right.appendChild(timeBalance);
                    
                    row.appendChild(left); 
                    row.appendChild(right); 
                    card.appendChild(row);
                });
                displayContent.appendChild(card);
            });
        }
        document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && overlay.style.display!=='none'){ closeDisplay(); } });

        /* ------------------ Modified PDF Export ------------------ */
        function exportPDF() {
            // REMOVED PERMISSION CHECK - allow all users to export PDF
            const selected = shiftSelect.value;
            if (!selected) { alert('Please select a shift first'); return; }
            const s = shifts.find(x => x.shift === selected);
            if (!s) return;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'pt', format: 'a4' });
            const marginLeft = 36;
            let cursorY = 40;

            // Title
            doc.setFontSize(18);
            doc.setTextColor(255, 215, 0);
            doc.text(`Shift ${s.shift} Report`, marginLeft, cursorY);
            cursorY += 24;

            // Date and shift info
            doc.setFontSize(10);
            doc.setTextColor(100);
            const nowStr = new Date().toLocaleString();
            doc.text(`Generated: ${nowStr}`, marginLeft, cursorY);
            cursorY += 14;
            doc.text(`Shift Time: ${s.startTime || '-'} ‚Üí ${s.endTime || '-'}`, marginLeft, cursorY);
            cursorY += 20;

            // Table header
            const head = [['Member', 'Task', 'Time(HH:MM:SS)', 'Priority', 'Status', 'Support', 'Attendance', 'Leave', 'Used (min)', 'Balance (min)']];
            const body = [];

            // Table rows
            s.members.forEach(m => {
                const leaveStatus = m.leave ? `${m.leave.startTime} - ${m.leave.endTime}` : '--';
                const used = m.usedMinutes || 0;
                const balance = m.balanceMinutes || DAILY_TIME_ALLOCATION;
                
                if (m.tasks && m.tasks.length > 0) {
                    m.tasks.forEach(task => {
                        body.push([
                            m.name, 
                            task.name || '--', 
                            formatHMS(task.elapsedSeconds||0), 
                            (task.priority||'--'), 
                            task.status.toUpperCase(), 
                            task.support||'--', 
                            m.attendance||'unmarked', 
                            leaveStatus, 
                            used.toString(), 
                            balance.toString()
                        ]);
                    });
                } else {
                    body.push([
                        m.name, 
                        '--', 
                        '00:00:00', 
                        '--', 
                        '--', 
                        '--', 
                        m.attendance||'unmarked', 
                        leaveStatus, 
                        used.toString(), 
                        balance.toString()
                    ]);
                }
            });

            // AutoTable
            doc.autoTable({
                startY: cursorY,
                head: head,
                body: body,
                styles: { fontSize: 9, cellPadding: 6 },
                headStyles: { fillColor: [40, 48, 72], textColor: 255 },
                margin: { left: marginLeft, right: marginLeft },
                theme: 'grid'
            });

            // Save file
            const fileName = `Shift_${s.shift}_Report_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
        }
        exportPdfBtn.addEventListener('click', exportPDF);

        /* ---------------- CSV Export ---------------- */
        csvExportBtn.addEventListener('click', ()=> {
            // REMOVED PERMISSION CHECK - allow all users to export CSV
            const selected = shiftSelect.value; if(!selected){ alert('Please select a shift first to export'); return; }
            const s = shifts.find(x=>x.shift===selected);
            if(!s) return;
            const rows = [['Name','Task','Time(HH:MM:SS)','Priority','Status','Support','Attendance','Leave','Used (min)','Balance (min)']];
            s.members.forEach(m=>{
                const leaveStatus = m.leave ? `${m.leave.startTime} - ${m.leave.endTime}` : '--';
                const used = m.usedMinutes || 0;
                const balance = m.balanceMinutes || DAILY_TIME_ALLOCATION;
                
                if (m.tasks && m.tasks.length > 0) {
                    m.tasks.forEach(task => {
                        rows.push([
                            m.name, 
                            task.name || '--', 
                            formatHMS(task.elapsedSeconds||0), 
                            (task.priority||'--'), 
                            task.status.toUpperCase(), 
                            task.support||'--', 
                            m.attendance||'unmarked', 
                            leaveStatus, 
                            used.toString(), 
                            balance.toString()
                        ]);
                    });
                } else {
                    rows.push([
                        m.name, 
                        '--', 
                        '00:00:00', 
                        '--', 
                        '--', 
                        '--', 
                        m.attendance||'unmarked', 
                        leaveStatus, 
                        used.toString(), 
                        balance.toString()
                    ]);
                }
            });
            const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
            const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `Shift_${s.shift}_export.csv`; document.body.appendChild(a); a.click(); a.remove();
            URL.revokeObjectURL(url);
        });

        /* ---------------- Daily Report & Chart ---------------- */
        dailyChartBtn.addEventListener('click', generateDailyReportAndChart);

        function generateDailyReportAndChart(){
            // REMOVED PERMISSION CHECK - allow all users to generate reports
            const today = new Date();
            const startWindow = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 7, 0, 0);
            const endWindow = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 19, 0, 0);

            const filtered = tasksHistory.filter(t => {
                const s = new Date(t.start);
                const e = new Date(t.end);
                return s >= startWindow && e <= endWindow && s.toDateString() === startWindow.toDateString();
            });

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({unit:'pt', format:'a4'});
            const ml = 36; let y = 48;
            doc.setFontSize(16); doc.setTextColor(255,215,0); doc.text(`Daily Report: ${startWindow.toDateString()}`, ml, y); y+=18;

            if(filtered.length === 0){
                doc.setFontSize(12); doc.setTextColor(255,120,120);
                doc.text('No tasks between 07:00 and 19:00 for today.', ml, y);
                doc.save(`Daily_Report_${startWindow.toISOString().split('T')[0]}.pdf`);
                showChartModal(filtered);
                return;
            }

            const head = [['Shift','Member','Task','Start','End','Duration','Support','CompletedBy','Attendance','Priority']];
            const body = filtered.map(t => [
                t.shift,
                t.member,
                t.task,
                new Date(t.start).toLocaleTimeString('en-GB'),
                new Date(t.end).toLocaleTimeString('en-GB'),
                formatHMS(t.durationSecs||0),
                t.support || '--',
                t.completedBy || '--',
                (t.attendance||'unmarked').toUpperCase(),
                (t.priority||'--').toUpperCase()
            ]);

            doc.autoTable({
                startY: y,
                head: head,
                body: body,
                styles: { fontSize: 9, cellPadding: 6 },
                headStyles: { fillColor: [40,48,72], textColor: 255 },
                margin: { left: ml, right: ml },
                theme: 'grid'
            });

            doc.save(`Daily_Report_${startWindow.toISOString().split('T')[0]}.pdf`);
            showChartModal(filtered);
        }

        let chartInstance = null;
        function showChartModal(filteredHistory){
            const agg = {};
            filteredHistory.forEach(item => {
                const key = item.task || '--';
                agg[key] = (agg[key] || 0) + (item.durationSecs || 0);
            });

            chartModal.style.display = 'flex';
            const labels = Object.keys(agg);
            const data = labels.map(l => agg[l]);

            const ctx = document.getElementById('dailyChart').getContext('2d');
            if(chartInstance){ chartInstance.destroy(); chartInstance = null; }

            if(labels.length === 0){
                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: ['No data'], datasets: [{ label: 'Duration (s)', data: [0] }] },
                    options: { responsive:true, plugins:{ legend:{ display:false }, title:{ display:true, text:'No tasks in 07:00-19:00' } } }
                });
                return;
            }

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total duration (seconds)',
                        data: data,
                        backgroundColor: labels.map((_,i)=>`rgba(${40 + (i*30)%200}, ${160 - (i*10)%120}, ${220 - (i*15)%200}, 0.9)`),
                        borderColor: 'rgba(255,255,255,0.08)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    scales: {
                        x: { title: { display:true, text: 'Seconds' }, beginAtZero: true },
                        y: { ticks: { autoSkip:false } }
                    },
                    plugins: {
                        legend: { display:false },
                        title: { display:true, text: 'Task durations (07:00‚Äì19:00)' },
                        tooltip: {
                            callbacks: {
                                label: function(context){
                                    const s = context.raw || 0;
                                    return ` ${formatHMS(s)} (${s} s)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        /* close chart */
        closeChartBtn.addEventListener('click', ()=> {
            chartModal.style.display = 'none';
            if(chartInstance){ chartInstance.destroy(); chartInstance = null; }
        });
        document.addEventListener('keydown', (e) => {
            if(e.key === 'Escape' && chartModal.style.display === 'flex'){
                chartModal.style.display = 'none';
                if(chartInstance){ chartInstance.destroy(); chartInstance = null; }
            }
        });

        /* ---------------- Dashboard (performance) ---------------- */
        dashboardBtn.addEventListener('click', ()=> {
            if(!canPerform('viewDashboard')) { showToast('Permission denied'); return; }
            generateDashboard();
            dashboardModal.style.display = 'flex';
        });
        document.getElementById('dash-close').addEventListener('click', ()=> { dashboardModal.style.display = 'none'; });

        let perfChart = null;
        function generateDashboard(){
            // aggregate by member total seconds & tasks completed
            const agg = {};
            tasksHistory.forEach(t => {
                const key = `${t.shift}::${t.member}`;
                agg[key] = agg[key] || { shift: t.shift, member: t.member, total:0, tasks:0 };
                agg[key].total += (t.durationSecs||0);
                agg[key].tasks += 1;
            });
            // include current running elapsed
            shifts.forEach(s=>{
                s.members.forEach(m=>{
                    if(m.tasks) {
                        m.tasks.forEach(task => {
                            if(task.elapsedSeconds && task.elapsedSeconds>0){
                                const key = `${s.shift}::${m.name}`;
                                agg[key] = agg[key] || { shift: s.shift, member: m.name, total:0, tasks:0 };
                                agg[key].total += task.elapsedSeconds;
                            }
                        });
                    }
                });
            });
           
            const arr = Object.values(agg);
            arr.sort((a,b)=>b.total - a.total);
            const top10 = arr.slice(0,10);
            const labels = top10.map(x=>x.member);
            const data = top10.map(x=>x.total);
            const tasks = top10.map(x=>x.tasks);

            const ctx = document.getElementById('perfChart').getContext('2d');
            if(perfChart) perfChart.destroy();

            perfChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total time (seconds)',
                            data: data,
                            backgroundColor: 'rgba(255,215,0,0.7)',
                            borderColor: 'rgba(255,215,0,1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Tasks completed',
                            data: tasks,
                            type: 'line',
                            borderColor: 'rgba(0,200,83,1)',
                            backgroundColor: 'rgba(0,200,83,0.1)',
                            borderWidth: 2,
                            pointRadius: 4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { ticks: { color: 'white' } },
                        y: { 
                            type: 'linear', display: true, position: 'left', title: { display: true, text: 'Time (seconds)' },
                            ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y1: {
                            type: 'linear', display: true, position: 'right', title: { display: true, text: 'Tasks completed' },
                            ticks: { color: 'rgba(0,200,83,1)' }, grid: { drawOnChartArea: false }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: 'white' } },
                        title: { display: true, text: 'Top 10 Members by Total Time & Tasks Completed', color: 'white' }
                    }
                }
            });

            // summary text
            const totalTime = arr.reduce((sum,x)=>sum+x.total,0);
            const avgTime = arr.length ? Math.round(totalTime/arr.length) : 0;
            const totalTasks = arr.reduce((sum,x)=>sum+x.tasks,0);
            document.getElementById('perf-summary').innerHTML = 
                `Total tracked time: <strong>${formatHMS(totalTime)}</strong> | Average per member: <strong>${formatHMS(avgTime)}</strong> | Total tasks completed: <strong>${totalTasks}</strong>`;
        }

        /* ---------------- Search & Filter ---------------- */
        searchInput.addEventListener('input', renderShifts);
        filterSelect.addEventListener('change', renderShifts);

        /* ---------------- QR Code ---------------- */
        qrBtn.addEventListener('click', ()=> { qrModal.style.display = 'flex'; qrOutput.innerHTML = ''; qrScanner.innerHTML = ''; });
        qrClose.addEventListener('click', ()=> { qrModal.style.display = 'none'; });

        generateQrBtn.addEventListener('click', ()=> {
            const sel = qrMemberSelect.value;
            if(!sel){ alert('Select a member'); return; }
            const [shiftName, memberName] = sel.split('::');
            const s = shifts.find(x=>x.shift===shiftName);
            const m = s.members.find(x=>x.name===memberName);
            if(!m) return;
            const data = JSON.stringify({ shift: shiftName, member: memberName, timestamp: Date.now() });
            qrOutput.innerHTML = `<div style="text-align:center;"><div style="margin-bottom:8px;">Scan this QR to check-in ${memberName}</div></div>`;
            // In production, use a QR library like qrcode.js
            // For demo, we'll just show the data
            qrOutput.innerHTML += `<div style="background:#fff;color:#000;padding:12px;border-radius:8px;word-break:break-all;font-family:monospace;font-size:0.9rem;">${data}</div>`;
            qrOutput.innerHTML += `<div style="margin-top:8px;color:var(--muted);font-size:0.85rem;">Placeholder: In production, this would show a scannable QR code</div>`;
        });

        let qrScannerInstance = null;
        scanQrBtn.addEventListener('click', ()=> {
            qrOutput.innerHTML = '<div>Initializing camera...</div>';
            if(!window.Html5Qrcode){ qrOutput.innerHTML='QR scanner library not loaded'; return; }
            if(qrScannerInstance){ qrScannerInstance.stop().then(()=>{ qrScannerInstance.clear(); }).catch(()=>{}); }
            qrScannerInstance = new Html5Qrcode("qr-scanner");
            qrScannerInstance.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 250 },
                (decodedText) => {
                    try{
                        const data = JSON.parse(decodedText);
                        const s = shifts.find(x=>x.shift===data.shift);
                        const m = s.members.find(x=>x.name===data.member);
                        if(m){
                            m.attendance = 'present';
                            renderShifts(); saveState();
                            qrOutput.innerHTML = `<div style="color:var(--good);font-weight:700;">Checked in ${m.name} (Shift ${s.shift})</div>`;
                            if(qrScannerInstance) qrScannerInstance.stop().then(()=>{ qrScannerInstance.clear(); qrScannerInstance=null; }).catch(()=>{});
                        } else {
                            qrOutput.innerHTML = `<div style="color:var(--warn);">Member not found</div>`;
                        }
                    }catch(e){
                        qrOutput.innerHTML = `<div style="color:var(--warn);">Invalid QR code</div>`;
                    }
                },
                (error) => { /* ignore */ }
            ).catch(err => { qrOutput.innerHTML = `Camera error: ${err}`; });
        });

        /* ---------------- Authentication & Permissions ---------------- */
        function canPerform(action){
            if(!currentUser || !currentUser.name) return false;
            const role = currentUser.role || 'employee';
            const perms = {
                'admin': ['assign','startStop','addEmployee','markAttendance','viewDashboard','export','reset'],
                'supervisor': ['assign','startStop','addEmployee','markAttendance','viewDashboard','export'],
                'employee': ['startStop','markAttendance'] // employees can start/stop their own tasks and mark own attendance
            };
            return perms[role] && perms[role].includes(action);
        }

        function applyRoleUI(){
            const role = currentUser.role || 'employee';
            userRoleEl.textContent = `${currentUser.name} (${role})`;
            userRoleEl.style.color = role==='admin' ? 'var(--gold)' : role==='supervisor' ? 'var(--good)' : 'var(--muted)';
            // show/hide UI elements based on role
            const adminOnly = document.querySelectorAll('.admin-only');
            adminOnly.forEach(el => el.style.display = role==='admin' ? 'block' : 'none');
        }

        function updateAuthUI(){
            const isLoggedIn = currentUser && currentUser.name;
            loginBtn.style.display = isLoggedIn ? 'none' : 'inline-block';
            changePassBtn.style.display = isLoggedIn ? 'inline-block' : 'none';
            logoutBtn.style.display = isLoggedIn ? 'inline-block' : 'none';
            if(isLoggedIn) applyRoleUI();
        }

        // Populate login modal user list
        function populateLoginUsers(){
            loginNameSelect.innerHTML = '';
            Object.keys(USERS).forEach(name => {
                const o = document.createElement('option'); o.value = name; o.textContent = name;
                loginNameSelect.appendChild(o);
            });
        }

        loginBtn.addEventListener('click', ()=> {
            populateLoginUsers();
            loginModal.style.display = 'flex';
            loginPassword.value = '';
        });
        loginClose.addEventListener('click', ()=> { loginModal.style.display = 'none'; });
        loginSubmit.addEventListener('click', ()=> {
            const name = loginNameSelect.value;
            const pwd = loginPassword.value;
            if(!name || !pwd){ alert('Select user and enter password'); return; }
            if(USERS[name] && USERS[name].password === pwd){
                currentUser = { name, role: USERS[name].role || 'employee' };
                saveState();
                applyRoleUI();
                updateAuthUI();
                loginModal.style.display = 'none';
                showToast(`Welcome ${name}!`);
            } else {
                alert('Invalid credentials');
            }
        });

        changePassBtn.addEventListener('click', ()=> {
            cpCurr.value = ''; cpNew.value = ''; cpConfirm.value = ''; cpMsg.textContent = '';
            changePassModal.style.display = 'flex';
        });
        cpClose.addEventListener('click', ()=> { changePassModal.style.display = 'none'; });
        cpSubmit.addEventListener('click', ()=> {
            const curr = cpCurr.value;
            const newP = cpNew.value;
            const conf = cpConfirm.value;
            if(!curr || !newP || !conf){ cpMsg.textContent = 'Fill all fields'; return; }
            if(newP !== conf){ cpMsg.textContent = 'New passwords do not match'; return; }
            if(!USERS[currentUser.name] || USERS[currentUser.name].password !== curr){
                cpMsg.textContent = 'Current password is incorrect'; return;
            }
            USERS[currentUser.name].password = newP;
            saveUsers(USERS);
            changePassModal.style.display = 'none';
            showToast('Password changed successfully');
        });

        logoutBtn.addEventListener('click', ()=> {
            currentUser = { name: null, role: 'employee' };
            saveState();
            updateAuthUI();
            showToast('Logged out');
        });

        /* ---------------- Progress Charts Button ---------------- */
        progressChartBtn.addEventListener('click', () => {
            updateProgressCharts();
            document.getElementById('progress-charts').scrollIntoView({ behavior: 'smooth' });
        });

        /* ---------------- Initialization ---------------- */
        function initializeApp() {
            // Initialize all components
            initWelcomeScreen();
            initTimeCalculator();
            initLeaveManagement();
            initTimeManagement();
            initializeMemberTasks(); // Initialize multiple tasks system
            initializeProgressCharts();
            
            // Set up event listeners
            setupEventListeners();
            
            // Initial renders
            renderShifts();
            updateProgressCharts();
            updateAuthUI();
        }

        function setupEventListeners() {
            // Export PDF
            exportPdfBtn.addEventListener('click', exportPDF);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    saveState();
                    showToast('Manual save completed');
                }
            });
        }

        // Initialize the application when the DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>

<!-- Injected: Move task control buttons to the left of member name and small styling tweaks -->
<style>
/* Ensure controls look good when moved to the left */
.task-controls {
    display: flex;
    gap: 6px;
    align-items: center;
    margin-right: 12px;
}
/* Reduce button sizes slightly when on the left to fit nicely */
.task-control-btn {
    width: 28px;
    height: 28px;
    font-size: 0.7rem;
    border-radius: 6px;
    padding: 0;
    min-width: auto;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}
/* Make sure li keeps good spacing when controls are on the left */
li { align-items: center; }
.left { display:flex; align-items:center; gap:8px; min-width:0; flex:1; }

/* For display overlay and other generated lists that use .task-controls keep consistent appearance */
#display-content .task-controls { margin-right: 8px; }
</style>

<script>
(function(){
    function moveMemberControls(){
        // Move .task-controls before the left block inside each task-list item
        document.querySelectorAll('li').forEach(li=>{
            try {
                const controls = li.querySelector('.task-controls');
                const left = li.querySelector('.left');
                if(controls && left && left.parentNode === li){
                    // If controls already before left, skip
                    if (li.firstElementChild === controls) return;
                    li.insertBefore(controls, left);
                }
            } catch(e){
                // ignore any unusual li elements (modals, etc.)
            }
        });
    }

    // Run on DOM ready
    document.addEventListener('DOMContentLoaded', function(){
        moveMemberControls();
    });

    // Re-run after every renderShifts if it exists: wrap the function so moves happen after UI updates
    if(window.renderShifts && typeof window.renderShifts === 'function'){
        const orig = window.renderShifts;
        window.renderShifts = function(){
            const ret = orig.apply(this, arguments);
            // small timeout to allow innerHTML inserts to complete
            setTimeout(moveMemberControls, 20);
            return ret;
        };
    }

    // Also observe mutations in the main container to catch dynamic changes
    const shiftContainer = document.getElementById('shift-container');
    if(shiftContainer){
        const mo = new MutationObserver(()=> {
            moveMemberControls();
        });
        mo.observe(shiftContainer, {childList:true, subtree:true, characterData:false});
    }
})();
</script>


<!-- Injected: Per-member PDF export (subtract minutes when multiple tasks assigned) -->
<!-- Requires html2pdf.js (included below via CDN) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<style>
.export-pdf-btn {
    position: fixed;
    right: 18px;
    bottom: 18px;
    z-index: 9999;
    background: #2563eb;
    color: white;
    padding: 10px 14px;
    border-radius: 8px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    cursor: pointer;
    font-weight: 600;
}
.export-pdf-batch-note { font-size: 0.85rem; margin-left:8px; color:#444; }
</style>

<button id="export-per-member-pdfs" class="export-pdf-btn">Export per-member PDFs</button>

<script>
(function(){
    // Utility: sanitize filename
    function sanitizeFilename(name){
        return name.replace(/[^a-z0-9_\- ]/gi, '_').trim();
    }

    // Core export function
    async function exportPerMemberPDFs(){
        const button = document.getElementById('export-per-member-pdfs');
        button.disabled = true;
        button.textContent = 'Exporting...';

        // Select all member list items. Adjust selector to match your markup if needed.
        // Example assumes each member is represented by an <li> element inside a container.
        const members = Array.from(document.querySelectorAll('li'));

        // Filter only those list items that look like members (heuristic: contain .member-name or .left)
        const memberItems = members.filter(li=> li.querySelector('.left') || li.querySelector('.member-name') );

        if(memberItems.length === 0){
            alert('No members found with the default selectors. Please check selectors in the injected script.');
            button.disabled = false;
            button.textContent = 'Export per-member PDFs';
            return;
        }

        // Loop through members and create a PDF per member
        for(let i=0;i<memberItems.length;i++){
            const li = memberItems[i];

            // --- Identify member name ---
            // Preferred selector: element with class "member-name" inside li, otherwise fall back to first .left or first strong/span
            let nameEl = li.querySelector('.member-name') || li.querySelector('.left b') || li.querySelector('.left strong') || li.querySelector('.left span') || li.querySelector('.left');
            let memberName = (nameEl ? nameEl.innerText : ('member_'+(i+1))).trim();
            if(!memberName) memberName = 'member_'+(i+1);

            // --- Identify minutes recorded ---
            // Preferred selector: element with class "minutes" or data attribute data-minutes. Adjust if your HTML uses different structure.
            let minutes = null;
            const minutesEl = li.querySelector('.minutes') || li.querySelector('[data-minutes]');
            if(minutesEl){
                minutes = parseInt(minutesEl.innerText.replace(/\D/g,'')) || parseInt(minutesEl.getAttribute('data-minutes')) || 0;
            } else {
                // Try to find a numeric text inside li labelled "min" or "minutes"
                const text = li.innerText || '';
                const m = text.match(/(\d+)\s*(?:min|mins|minutes|‡∑Ä‡∑í‡∂±‡∑è‡∂©‡∑í)/i);
                if(m) minutes = parseInt(m[1]);
            }
            if(isNaN(minutes) || minutes === null) minutes = 0;

            // --- Count assigned tasks ---
            // Preferred selector: items with class .task.assigned inside the member li. Adjust if needed.
            const tasksAssigned = li.querySelectorAll('.task.assigned, .assigned-task, .task.assignment').length || 0;

            // Calculate reduced minutes: subtract 660 per extra task beyond the first.
            const extraTasks = Math.max(0, tasksAssigned - 1);
            const reducedMinutes = Math.max(0, minutes - (660 * extraTasks));

            // Prepare export block (clean, simple layout)
            const exportBlock = document.createElement('div');
            exportBlock.style.width = '700px';
            exportBlock.style.padding = '20px';
            exportBlock.style.fontFamily = 'Arial, sans-serif';
            exportBlock.style.color = '#111';
            exportBlock.innerHTML = `
                <h2 style="margin:0 0 6px 0;">Member: ${memberName}</h2>
                <div style="margin-bottom:8px;">Original minutes: <strong>${minutes}</strong></div>
                <div style="margin-bottom:8px;">Assigned tasks: <strong>${tasksAssigned}</strong></div>
                <div style="margin-bottom:18px;">Reduced minutes (after subtracting 660 per extra task): <strong>${reducedMinutes}</strong></div>
                <hr/>
                <div>${li.innerText.replace(/\\s+/g,' ').trim()}</div>
            `;

            // Append to body (off-screen) so html2pdf can render, but hide it visually
            exportBlock.style.position = 'fixed';
            exportBlock.style.left = '-9999px';
            document.body.appendChild(exportBlock);

            // Use html2pdf to save the PDF. The library returns a Promise from .save() so we await it.
            try {
                await html2pdf().set({ margin:10, filename: sanitizeFilename(memberName)+'.pdf', jsPDF: { unit: 'pt', format: 'a4', orientation: 'portrait' } }).from(exportBlock).save();
            } catch(e){
                console.error('Failed to export PDF for', memberName, e);
                alert('Failed to export PDF for ' + memberName + '. Check console for errors.');
            } finally {
                // remove temporary block
                document.body.removeChild(exportBlock);
            }

            // Small delay to avoid overwhelming the browser (optional)
            await new Promise(res=>setTimeout(res, 250));
        }

        button.disabled = false;
        button.textContent = 'Export per-member PDFs';
        alert('Done exporting PDFs for ' + memberItems.length + ' members.');
    }

    document.getElementById('export-per-member-pdfs').addEventListener('click', exportPerMemberPDFs);
})();
</script>

</body>
</html>